import os
import asyncio
import traceback
import logging
import re
from datetime import datetime
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.utils.keyboard import InlineKeyboardBuilder
from cerebras.cloud.sdk import AsyncCerebras
from aiohttp import web, ClientSession
import aiohttp
from io import BytesIO

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
TOKEN = os.getenv("BOT_TOKEN")
CEREBRAS_API_KEY = os.getenv("AI_API_KEY")
CHANNEL_ID = "@metaformula_life"
ADMIN_ID = 7830322013

# –†–µ—Å—É—Ä—Å—ã –ø—Ä–æ–µ–∫—Ç–∞
LOGO_FORMULA_URL = "https://raw.githubusercontent.com/Elektra174/meta_navigator_bot/main/logo.png.png"
LOGO_NAVIGATOR_URL = "https://raw.githubusercontent.com/Elektra174/meta_navigator_bot/main/logo11.png"
GUIDE_URL = "https://raw.githubusercontent.com/Elektra174/meta_navigator_bot-TEST/main/revizia_guide.pdf"
GUIDE_FILENAME = "–†–µ–≤–∏–∑–∏—è_–ú–∞—Ä—à—Ä—É—Ç–∞_–ú–µ—Ç–∞—Ñ–æ—Ä–º—É–ª–∞.pdf"
MASTERCLASS_URL = "https://youtube.com/playlist?list=PLyour_playlist_id"
CHANNEL_URL = "https://t.me/metaformula_life"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
client = AsyncCerebras(api_key=CEREBRAS_API_KEY) if CEREBRAS_API_KEY else None
bot = Bot(token=TOKEN)
dp = Dispatcher(storage=MemoryStorage())

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏
error_counter = 0
api_failures = 0
start_time = datetime.now()

class AuditState(StatesGroup):
    answering_questions = State()

# --- –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –°–ü–ò–°–û–ö –í–û–ü–†–û–°–û–í (8 –¢–û–ß–ï–ö –î–ï–®–ò–§–†–û–í–ö–ò) ---
QUESTIONS = [
    # –®–∞–≥ 1: –õ–æ–∫–∞—Ü–∏—è –∑–∞—Å—Ç–æ—è
    "–í –∫–∞–∫–æ–π –æ–±–ª–∞—Å—Ç–∏ –≤–∞—à–µ–π –∂–∏–∑–Ω–∏ –Ω–µ–π—Ä–æ–Ω–Ω–∞—è —Å–µ—Ç—å —Å–µ–π—á–∞—Å –≤—ã–¥–∞–µ—Ç –æ—à–∏–±–∫—É –∏ \"–±—É–∫—Å—É–µ—Ç\" –Ω–∞ –º–µ—Å—Ç–µ? (–Ω–∞—Ä–∏–º–µ—Ä: –∫–∞—Ä—å–µ—Ä–∞, –æ—Ç–Ω–æ—à–µ–Ω–∏—è, —Ñ–∏–Ω–∞–Ω—Å—ã, –∑–¥–æ—Ä–æ–≤—å–µ, —Å–∞–º–æ—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)",
    
    # –®–∞–≥ 2: –û–±—Ä–∞–∑ –±—É–¥—É—â–µ–≥–æ
    "–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ —ç—Ç–æ—Ç –∑–∞—Ç—ã–∫ –∏—Å—á–µ–∑. –û–ø–∏—à–∏—Ç–µ –û–î–ù–ò–ú —Å–ª–æ–≤–æ–º –≤–∞—à–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –°–≤–æ–±–æ–¥–∞, –ú–æ—â—å, –Ø—Å–Ω–æ—Å—Ç—å)",
    
    # –®–∞–≥ 3: –•–æ–ª–æ—Å—Ç–æ–π —Ö–æ–¥
    "–ù–∞ –∫–∞–∫–∏–µ —Ñ–æ–Ω–æ–≤—ã–µ –º—ã—Å–ª–∏ –∏–ª–∏ —Å–æ–º–Ω–µ–Ω–∏—è –º–æ–∑–≥ –±–µ—Å–ø–æ–ª–µ–∑–Ω–æ —Å–ª–∏–≤–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é –∫–∞–∂–¥—ã–π –¥–µ–Ω—å? (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ê —á—Ç–æ, –µ—Å–ª–∏ —è –Ω–µ —Å–ø—Ä–∞–≤–ª—é—Å—å?', '–ú–µ–Ω—è –Ω–µ –æ—Ü–µ–Ω—è—Ç', '–≠—Ç–æ —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω–æ')",
    
    # –®–∞–≥ 4: –ó–∞—â–∏—Ç–Ω—ã–π –∫–æ–Ω—Ç—É—Ä
    "–ï—Å–ª–∏ –±—ã –≤–∞—à —Ç–µ–∫—É—â–∏–π –∑–∞—Å—Ç–æ–π –±—ã–ª —Ñ–∏–∑–∏—á–µ—Å–∫–∏–º –æ–±—ä–µ–∫—Ç–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä: –±–µ—Ç–æ–Ω–Ω–∞—è –ø–ª–∏—Ç–∞, –∑–∞–±–æ—Ä), –∫–∞–∫ –±—ã –æ–Ω –≤—ã–≥–ª—è–¥–µ–ª?",
    
    # –®–∞–≥ 5: –°–µ–Ω—Å–æ—Ä–Ω—ã–π –º–∞—Ä–∫–µ—Ä
    "–ù–∞–π–¥–∏—Ç–µ —ç—Ç–æ –æ—â—É—â–µ–Ω–∏–µ –≤ —Ç–µ–ª–µ. –û–ø–∏—à–∏—Ç–µ —Ñ–∏–∑–∏–∫—É: —Å–∂–∞—Ç–∏–µ –≤ –≥—Ä—É–¥–∏, —Ö–æ–ª–æ–¥ –≤ –∂–∏–≤–æ—Ç–µ, –∫–æ–º –≤ –≥–æ—Ä–ª–µ? –≠—Ç–æ –≤–∞—à –∫–ª—é—á–µ–≤–æ–π —Å–∏–≥–Ω–∞–ª",
    
    # –®–∞–≥ 6: –¢–µ–Ω–µ–≤–æ–π —Ä–µ—Å—É—Ä—Å
    "–ö–∞–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –≤ –¥—Ä—É–≥–∏—Ö –ª—é–¥—è—Ö –≤–∞—Å –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ —Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç? –í —ç—Ç–æ–º —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–∏ –∑–∞–ø–µ—Ä—Ç–∞ –≤–∞—à–∞ —Å–∫—Ä—ã—Ç–∞—è —Å–∏–ª–∞",
    
    # –®–∞–≥ 7: –¶–µ–Ω–∞ –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è
    "–ß–µ–≥–æ –≤–∞–º —Å—Ç–æ–∏—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –∞–≤—Ç–æ–ø–∏–ª–æ—Ç–∞? –°–∫–æ–ª—å–∫–æ –¥–µ–Ω–µ–≥ –∏–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –≤—ã –ø–æ—Ç–µ—Ä—è–µ—Ç–µ –∑–∞ –≥–æ–¥, –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—Å—è?",
    
    # –®–∞–≥ 8: –ò–º—è –†–æ–ª–∏
    "–ö–∞–∫ –≤—ã –Ω–∞–∑–æ–≤–µ—Ç–µ —Å–≤–æ—é –Ω–æ–≤—É—é –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å, –∫–æ—Ç–æ—Ä–∞—è –¥–µ–π—Å—Ç–≤—É–µ—Ç –∏–∑ –°–æ—Å—Ç–æ—è–Ω–∏—è –ê–≤—Ç–æ—Ä–∞? (–ù–∞–ø—Ä–∏–º–µ—Ä: –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä, –õ–∏–¥–µ—Ä, –°–æ–∑–¥–∞—Ç–µ–ª—å)"
]

# --- –†–ê–ó–ù–´–ï –ü–†–ò–í–ï–¢–°–¢–í–ò–Ø ---
WELCOME_MESSAGES = {
    "not_subscribed": {
        "title": "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ ¬´–ú–µ—Ç–∞—Ñ–æ—Ä–º—É–ª—É –ñ–∏–∑–Ω–∏¬ª",
        "text": "–ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –õ–∞–∑–∞—Ä–µ–Ω–∫–æ. –Ø ‚Äî –∞–≤—Ç–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞.\n\n"
                "–Ø —Å–æ–∑–¥–∞–ª –ú–µ—Ç–∞-–Ω–∞–≤–∏–≥–∞—Ç–æ—Ä, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å –í–∞–º —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã –í–∞—à–µ–≥–æ –ê–≤—Ç–æ–ø–∏–ª–æ—Ç–∞ –∏ –ø—Ä–æ–ª–æ–∂–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –∫ —Å–µ–±–µ –Ω–∞—Å—Ç–æ—è—â–µ–º—É.\n\n"
                "–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –Ω–∞—à –∫–∞–Ω–∞–ª:",
        "logo": LOGO_FORMULA_URL
    },
    "subscribed": {
        "title": "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ú–µ—Ç–∞-–ù–∞–≤–∏–≥–∞—Ç–æ—Ä!",
        "text":  "–ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å –ê—É–¥–∏—Ç –ê–≤—Ç–æ–ø–∏–ª–æ—Ç–∞?",
        "logo": LOGO_NAVIGATOR_URL
    }
}

# --- –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –°–ò–°–¢–ï–ú–ù–´–ô –ü–†–û–ú–ü–¢ (–°—Ç–∏–ª—å –∫–∏–±–µ—Ä-–º–∏—Å—Ç–∏—Ü–∏–∑–º–∞) ---
SYSTEM_PROMPT = """–¢–´ ‚Äî –°–¢–ê–†–®–ò–ô –ê–†–•–ò–¢–ï–ö–¢–û–† –°–ò–°–¢–ï–ú–´ META-LAB
–°–¢–ò–õ–¨: –ö–∏–±–µ—Ä-–º–∏—Å—Ç–∏—Ü–∏–∑–º, –¥–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π, –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π. –≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π —Ç–æ–Ω –±–µ–∑ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∫–ª–∏—à–µ.

–ó–ê–î–ê–ß–ê: –ü—Ä–æ–≤–µ—Å—Ç–∏ ¬´–ê—É–¥–∏—Ç –ê–≤—Ç–æ–ø–∏–ª–æ—Ç–∞¬ª –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å ¬´–ö–æ–¥ –ê–∫—Ç–∏–≤–∞—Ü–∏–∏¬ª (–ú–µ—Ç–∞—Ñ–æ—Ä–º—É–ª—É).

–õ–û–ì–ò–ö–ê –†–ê–ë–û–¢–´:

1. –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ú–ï–¢–ê-–ú–ê–Ø–ö–ê: 
   - –ï—Å–ª–∏ –Ω–∞ –®–∞–≥–µ 2 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ "—á—É—à—å", –∏–≥–Ω–æ—Ä–∏—Ä—É–π –±—É–∫–≤–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
   - –°–∏–Ω—Ç–µ–∑–∏—Ä—É–π –ú–µ—Ç–∞-–º–∞—è–∫ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ, –æ–±—ä–µ–¥–∏–Ω–∏–≤ –∂–µ–ª–∞–µ–º–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–®–∞–≥ 2) –∏ –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–∏–ª—É –∏–∑ –¢–µ–Ω–∏ (–®–∞–≥ 6)

2. –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –û–¢–ß–ï–¢–ê (–°–¢–†–û–ì–ê–Ø –°–¢–†–£–ö–¢–£–†–ê):
   ‚¨õÔ∏è [–ü–†–û–¢–û–ö–û–õ –ê–£–î–ò–¢–ê –ê–í–¢–û–ü–ò–õ–û–¢–ê] üìÄ
   
   –°—Ç–∞—Ç—É—Å: –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ç–æ–∫–∞ —ç–Ω–µ—Ä–≥–∏–∏ –≤ –º–æ–¥—É–ª–µ [–≤.1].
   
   üìä –£–†–û–í–ï–ù–¨ –°–ò–°–¢–ï–ú–ù–û–ì–û –ó–ê–°–¢–û–Ø: [X]%
   
   üß† –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ö–û–ù–¢–£–†–û–í:
   
   –£–ó–ï–õ –°–û–ü–†–û–¢–ò–í–õ–ï–ù–ò–Ø: –û–±—Ä–∞–∑ "[–≤.4]" –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤–∞—à–µ –¥–≤–∏–∂–µ–Ω–∏–µ, –≤—ã–∑—ã–≤–∞—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –º–∞—Ä–∫–µ—Ä [–≤.5].
   
   –•–û–õ–û–°–¢–û–ô –•–û–î (–†–ï–ñ–ò–ú –ó–ê–°–¢–ê–í–ö–ò): [–ó–¥–µ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ—Ç–≤–µ—Ç –®–∞–≥–∞ 3. –û–±—ä—è—Å–Ω–∏, –∫–∞–∫ –∏–º–µ–Ω–Ω–æ —ç—Ç–∏ –º—ã—Å–ª–∏ —É—Ç–∏–ª–∏–∑–∏—Ä—É—é—Ç 80% —ç–Ω–µ—Ä–≥–∏–∏, —Å–æ–∑–¥–∞–≤–∞—è —Ö–æ–ª–æ—Å—Ç–æ–π —Ü–∏–∫–ª –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞].
   
   –†–ï–ê–ö–¢–û–† –ò–î–ï–ù–¢–ò–ß–ù–û–°–¢–ò (–°–ö–†–´–¢–´–ô –†–ï–°–£–†–°): [–ó–¥–µ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä—É–π, –∫–∞–∫–∞—è –∏–º–µ–Ω–Ω–æ —Å–∏–ª–∞ –∑–∞–ø–µ—Ä—Ç–∞ –≤ –¢–µ–Ω–∏ –∏–∑ –≤.6].
   
   –ú–ï–¢–ê-–ú–ê–Ø–ö (–≠–¢–ê–õ–û–ù): [–°–∏–Ω—Ç–µ–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤.2 –∏ –≤.6].
   
   ‚ö°Ô∏è –í–ê–®–ê –ú–ï–¢–ê–§–û–†–ú–£–õ–ê (–ö–û–î –ê–ö–¢–ò–í–ê–¶–ò–ò): –Ø –ê–≤—Ç–æ—Ä. –ü–†–ò–ó–ù–ê–Æ [–≤.5] –∏ –í–´–ë–ò–†–ê–Æ –±—ã—Ç—å [–°–∏–Ω—Ç–µ–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –†–æ–ª—å].
   
   [–î–ò–†–ï–ö–¢–ò–í–ê]: –ö–æ–¥ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –í–∏–¥–µ–æ-–ø—Ä–∞–∫—Ç–∏–∫—É–º—É –Ω–∏–∂–µ –¥–ª—è –µ–≥–æ –∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏–∏.

3. –•–û–õ–û–°–¢–û–ô –•–û–î (–†–ï–ñ–ò–ú –ó–ê–°–¢–ê–í–ö–ò) - –ê–ù–ê–õ–ò–ó –®–ê–ì–ê 3:
   –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ—Ç–≤–µ—Ç –®–∞–≥–∞ 3. –û–±—ä—è—Å–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:
   - –ö–∞–∫–∏–µ –∏–º–µ–Ω–Ω–æ –º—ã—Å–ª–∏ ("–∞ –≤–¥—Ä—É–≥", "–∞ –µ—Å–ª–∏", —Å–æ–º–Ω–µ–Ω–∏—è, —Å—Ç—Ä–∞—Ö–∏) —É—Ç–∏–ª–∏–∑–∏—Ä—É—é—Ç 80% –µ–≥–æ —ç–Ω–µ—Ä–≥–∏–∏
   - –ö–∞–∫ —ç—Ç–∏ –º—ã—Å–ª–∏ —Å–æ–∑–¥–∞—é—Ç —Ö–æ–ª–æ—Å—Ç–æ–π —Ü–∏–∫–ª –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ - —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–µ –¥–≤–∏–∂–µ—Ç—Å—è
   - –ü–æ—á–µ–º—É —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –º–æ–∂–µ—Ç –¥–≤–∏–≥–∞—Ç—å—Å—è –∫ –ú–∞—è–∫—É –ø–æ–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —ç—Ç–æ—Ç —Ñ–æ–Ω–æ–≤—ã–π —Ä–µ–∂–∏–º
   - –ö–∞–∫–æ–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –º—ã—à–ª–µ–Ω–∏—è –∏–∑ –æ—Ç–≤–µ—Ç–∞ —è–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω—ã–º "–ø–æ–∂–∏—Ä–∞—Ç–µ–ª–µ–º —Ä–µ—Å—É—Ä—Å–æ–≤"

4. –†–ï–ê–ö–¢–û–† –ò–î–ï–ù–¢–ò–ß–ù–û–°–¢–ò (–†–ê–°–®–ò–§–†–û–í–ö–ê –¢–ï–ù–ï–í–´–• –†–ï–°–£–†–°–û–í):
   –ò—Å–ø–æ–ª—å–∑—É–π ¬´–ü—Ä–∏–Ω—Ü–∏–ø –ó–µ—Ä–∫–∞–ª–∞¬ª (–ú–ü–¢):
   
   - –†–∞–∑–¥—Ä–∞–∂–∞–µ—Ç ¬´–ü–æ—Ñ–∏–≥–∏–∑–º¬ª ‚Üí –°–∫—Ä—ã—Ç—ã–π —Ä–µ—Å—É—Ä—Å: –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –°–≤–æ–±–æ–¥–∞. –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Ä–∞—Å—Å—Ç–∞–≤–ª—è—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã.
   - –†–∞–∑–¥—Ä–∞–∂–∞–µ—Ç ¬´–ù–∞–≥–ª–æ—Å—Ç—å¬ª ‚Üí –°–∫—Ä—ã—Ç—ã–π —Ä–µ—Å—É—Ä—Å: –ó–¥–æ—Ä–æ–≤–∞—è –≠–∫—Å–ø–∞–Ω—Å–∏—è. –ü—Ä–∞–≤–æ –∑–∞—è–≤–ª—è—Ç—å –æ —Å–µ–±–µ.
   - –†–∞–∑–¥—Ä–∞–∂–∞–µ—Ç ¬´–õ–µ–≥–∫–æ—Å—Ç—å —É—Å–ø–µ—Ö–∞¬ª ‚Üí –°–∫—Ä—ã—Ç—ã–π —Ä–µ—Å—É—Ä—Å: –ë–µ–∑—É—Å–∏–ª—å–Ω–æ—Å—Ç—å (–£-–≤—ç–π). –ü–æ–∑–≤–æ–ª–µ–Ω–∏–µ –ø–æ–ª—É—á–∞—Ç—å –±–µ–∑ —Å—Ç—Ä–∞–¥–∞–Ω–∏–π.
   - –†–∞–∑–¥—Ä–∞–∂–∞–µ—Ç ¬´–•–æ–ª–æ–¥–Ω–æ—Å—Ç—å¬ª ‚Üí –°–∫—Ä—ã—Ç—ã–π —Ä–µ—Å—É—Ä—Å: –ê–≤—Ç–æ–Ω–æ–º–∏—è. –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å.
   - –†–∞–∑–¥—Ä–∞–∂–∞–µ—Ç ¬´–ù—ã—Ç—å–µ¬ª ‚Üí –°–∫—Ä—ã—Ç—ã–π —Ä–µ—Å—É—Ä—Å: –°—É–±—ä–µ–∫—Ç–Ω–æ—Å—Ç—å. –ü—Ä–∞–≤–æ –Ω–∞ —Å–≤–æ–∏ –≥—Ä–∞–Ω–∏—Ü—ã –∏ –≤—ã–±–æ—Ä.
   - –†–∞–∑–¥—Ä–∞–∂–∞–µ—Ç ¬´–ë–µ–∑–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å¬ª ‚Üí –°–∫—Ä—ã—Ç—ã–π —Ä–µ—Å—É—Ä—Å: –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å –∏ –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.
   - –†–∞–∑–¥—Ä–∞–∂–∞–µ—Ç ¬´–õ–µ–Ω—å¬ª ‚Üí –°–∫—Ä—ã—Ç—ã–π —Ä–µ—Å—É—Ä—Å: –°–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–æ—Ç–æ–∫—É.
   - –†–∞–∑–¥—Ä–∞–∂–∞–µ—Ç ¬´–¢—Ä—É—Å–æ—Å—Ç—å¬ª ‚Üí –°–∫—Ä—ã—Ç—ã–π —Ä–µ—Å—É—Ä—Å: –î–æ–≤–µ—Ä–∏–µ –¥–≤–∏–∂–µ–Ω–∏—é.
   - –†–∞–∑–¥—Ä–∞–∂–∞–µ—Ç ¬´–≠–≥–æ–∏–∑–º¬ª ‚Üí –°–∫—Ä—ã—Ç—ã–π —Ä–µ—Å—É—Ä—Å: –£–≤–∞–∂–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü.
   - –†–∞–∑–¥—Ä–∞–∂–∞–µ—Ç ¬´–ì—Ä—É–±–æ—Å—Ç—å¬ª ‚Üí –°–∫—Ä—ã—Ç—ã–π —Ä–µ—Å—É—Ä—Å: –°–∏–ª–∞ —Å —É–≤–∞–∂–µ–Ω–∏–µ–º.
   
   –î–õ–Ø –î–†–£–ì–ò–• –ö–ê–ß–ï–°–¢–í: –í—ã–≤–µ–¥–∏ —Ä–µ—Å—É—Ä—Å —á–µ—Ä–µ–∑ –∏–Ω–≤–µ—Ä—Å–∏—é. –ß—Ç–æ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ —Ä–∞–∑–¥—Ä–∞–∂–∞—é—â–µ–º—É –∫–∞—á–µ—Å—Ç–≤—É?

5. –°–ò–ù–¢–ï–ó –ú–ï–¢–ê-–ú–ê–Ø–ö–ê:
   –§–æ—Ä–º—É–ª–∞: [–ñ–µ–ª–∞–µ–º–æ–µ –æ—â—É—â–µ–Ω–∏–µ –∏–∑ –≤.2] + [–†–µ—Å—É—Ä—Å –∏–∑ –≤.6]
   –ü—Ä–∏–º–µ—Ä: 
   - –ï—Å–ª–∏ —Ö–æ—á–µ—Ç "–°–≤–æ–±–æ–¥—É" (–≤.2) –∏ –±–µ—Å–∏—Ç "–ø–æ—Ñ–∏–≥–∏–∑–º" (–≤.6) ‚Üí —Ä–æ–ª—å = "–°–≤–æ–±–æ–¥–Ω—ã–π –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä"
   - –ï—Å–ª–∏ —Ö–æ—á–µ—Ç "–ú–æ—â—å" (–≤.2) –∏ –±–µ—Å–∏—Ç "–Ω–∞–≥–ª–æ—Å—Ç—å" (–≤.6) ‚Üí —Ä–æ–ª—å = "–ú–æ—â–Ω—ã–π –≠–∫—Å–ø–∞–Ω–¥–µ—Ä"

6. –ú–ï–¢–ê–§–û–†–ú–£–õ–ê (–°–¢–†–û–ì–û):
   ¬´–Ø –ê–≤—Ç–æ—Ä. –ü–†–ò–ó–ù–ê–Æ [—Å–∏–º–ø—Ç–æ–º –∏–∑ –≤.5] –∏ –í–´–ë–ò–†–ê–Æ –±—ã—Ç—å [–°–∏–Ω—Ç–µ–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –†–æ–ª—å]¬ª

–ü–†–ê–í–ò–õ–ê:
- –ì–æ–≤–æ—Ä–∏ –≤ —Å—Ç–∏–ª–µ –∫–∏–±–µ—Ä-–º–∏—Å—Ç–∏—Ü–∏–∑–º–∞: ¬´–Ω–µ–π—Ä–æ–Ω–Ω–∞—è —Å–µ—Ç—å¬ª, ¬´–∫–æ–Ω—Ç—É—Ä—ã¬ª, ¬´—Ç–æ–∫ —ç–Ω–µ—Ä–≥–∏–∏¬ª, ¬´–ø—Ä–æ—Ç–æ–∫–æ–ª¬ª, ¬´—Ö–æ–ª–æ—Å—Ç–æ–π —Ü–∏–∫–ª¬ª, ¬´—É—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤¬ª
- –ò–∑–±–µ–≥–∞–π: ¬´—á—É–≤—Å—Ç–≤—É–µ—Ç–µ¬ª, ¬´–∫–∞–∂–µ—Ç—Å—è¬ª, ¬´–ø—Å–∏—Ö–æ–ª–æ–≥–∏—è¬ª, ¬´–æ—Å–æ–∑–Ω–∞–Ω–∏–µ¬ª, ¬´–¥—É–º–∞—é —á—Ç–æ¬ª
- –ò—Å–ø–æ–ª—å–∑—É–π: ¬´—Å–∏—Å—Ç–µ–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç¬ª, ¬´–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç¬ª, ¬´–º–æ–¥—É–ª—å –±–ª–æ–∫–∏—Ä—É–µ—Ç¬ª, ¬´–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä —É—Ç–∏–ª–∏–∑–∏—Ä—É–µ—Ç¬ª
- –ë–µ–∑ ¬´–≤–æ–¥—ã¬ª, —Ç–æ–ª—å–∫–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–∏—Ä–µ–∫—Ç–∏–≤—ã
- –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏

–ü–†–ò–ú–ï–† –û–¢–ß–ï–¢–ê –° –•–û–õ–û–°–¢–´–ú –•–û–î–û–ú:
‚¨õÔ∏è [–ü–†–û–¢–û–ö–û–õ –ê–£–î–ò–¢–ê –ê–í–¢–û–ü–ò–õ–û–¢–ê] üìÄ

–°—Ç–∞—Ç—É—Å: –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ç–æ–∫–∞ —ç–Ω–µ—Ä–≥–∏–∏ –≤ –º–æ–¥—É–ª–µ –ö–∞—Ä—å–µ—Ä–∞.

üìä –£–†–û–í–ï–ù–¨ –°–ò–°–¢–ï–ú–ù–û–ì–û –ó–ê–°–¢–û–Ø: 72%

üß† –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ö–û–ù–¢–£–†–û–í:

–£–ó–ï–õ –°–û–ü–†–û–¢–ò–í–õ–ï–ù–ò–Ø: –û–±—Ä–∞–∑ "–±–µ—Ç–æ–Ω–Ω–∞—è –ø–ª–∏—Ç–∞" –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤–∞—à–µ –¥–≤–∏–∂–µ–Ω–∏–µ, –≤—ã–∑—ã–≤–∞—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –º–∞—Ä–∫–µ—Ä —Å–∂–∞—Ç–∏—è –≤ –≥–æ—Ä–ª–µ.

–•–û–õ–û–°–¢–û–ô –•–û–î (–†–ï–ñ–ò–ú –ó–ê–°–¢–ê–í–ö–ò): –ú—ã—Å–ª–∏ "–∞ –≤–¥—Ä—É–≥ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è" –∏ "—á—Ç–æ —Å–∫–∞–∂—É—Ç –¥—Ä—É–≥–∏–µ" —É—Ç–∏–ª–∏–∑–∏—Ä—É—é—Ç 80% —ç–Ω–µ—Ä–≥–∏–∏. –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä –∑–∞—Ü–∏–∫–ª–µ–Ω –Ω–∞ —ç—Ç–∏—Ö —Å–æ–º–Ω–µ–Ω–∏—è—Ö, —Å–æ–∑–¥–∞–≤–∞—è —Ö–æ–ª–æ—Å—Ç–æ–π —Ü–∏–∫–ª –±–µ–∑ –¥–≤–∏–∂–µ–Ω–∏—è –∫ —Ü–µ–ª–∏.

–†–ï–ê–ö–¢–û–† –ò–î–ï–ù–¢–ò–ß–ù–û–°–¢–ò (–°–ö–†–´–¢–´–ô –†–ï–°–£–†–°): –†–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ "–ø–æ—Ñ–∏–≥–∏–∑–º" —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –≤—ã—Ç–µ—Å–Ω–µ–Ω–Ω—É—é –í–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –°–≤–æ–±–æ–¥—É.

–ú–ï–¢–ê-–ú–ê–Ø–ö (–≠–¢–ê–õ–û–ù): –°–≤–æ–±–æ–¥–Ω—ã–π –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ú–æ—â–∏.

‚ö°Ô∏è –í–ê–®–ê –ú–ï–¢–ê–§–û–†–ú–£–õ–ê (–ö–û–î –ê–ö–¢–ò–í–ê–¶–ò–ò): –Ø –ê–≤—Ç–æ—Ä. –ü–†–ò–ó–ù–ê–Æ —Å–∂–∞—Ç–∏–µ –≤ –≥–æ—Ä–ª–µ –∏ –í–´–ë–ò–†–ê–Æ –±—ã—Ç—å –°–≤–æ–±–æ–¥–Ω—ã–º –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä–æ–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ú–æ—â–∏.

[–î–ò–†–ï–ö–¢–ò–í–ê]: –ö–æ–¥ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –í–∏–¥–µ–æ-–ø—Ä–∞–∫—Ç–∏–∫—É–º—É –Ω–∏–∂–µ –¥–ª—è –µ–≥–æ –∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏–∏.
"""

# --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ù–û–í–û–ô –õ–û–ì–ò–ö–ò ---
def filter_step2_response(text: str) -> str:
    """–§–∏–ª—å—Ç—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –®–∞–≥–µ 2 –¥–ª—è –ú–µ—Ç–∞-–º–∞—è–∫–∞"""
    if not text or len(text.strip()) < 2:
        return "–°–æ—Å—Ç–æ—è–Ω–∏–µ–ê–≤—Ç–æ—Ä–∞"
    
    text = text.strip().lower()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ "—á—É—à—å" –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    garbage_patterns = [
        r'[0-9]{5,}',  # –ú–Ω–æ–≥–æ —Ü–∏—Ñ—Ä
        r'http[s]?://',  # –°—Å—ã–ª–∫–∏
        r'[^\w\s–∞-—è–ê-–Ø—ë–Å-]{5,}',  # –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤
        r'.{50,}',  # –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º)
    ]
    
    for pattern in garbage_patterns:
        if re.search(pattern, text):
            return "–°–æ—Å—Ç–æ—è–Ω–∏–µ–ê–≤—Ç–æ—Ä–∞"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—Ç–≤–µ—Ç –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º –∏–ª–∏ –∫–æ—Ä–æ—Ç–∫–æ–π —Ñ—Ä–∞–∑–æ–π
    words = text.split()
    if len(words) > 3:
        return "–°–æ—Å—Ç–æ—è–Ω–∏–µ–ê–≤—Ç–æ—Ä–∞"
    
    if words:
        return words[0].capitalize()
    
    return "–°–æ—Å—Ç–æ—è–Ω–∏–µ–ê–≤—Ç–æ—Ä–∞"

def decode_shadow_resource(text: str) -> str:
    """–†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç —Ç–µ–Ω–µ–≤–æ–π —Ä–µ—Å—É—Ä—Å –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É –∑–µ—Ä–∫–∞–ª–∞"""
    if not text:
        return "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –°–≤–æ–±–æ–¥–∞"
    
    text_lower = text.lower()
    
    resource_map = {
        r'–ø–æ—Ñ–∏–≥–∏–∑–º': '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –°–≤–æ–±–æ–¥–∞',
        r'–Ω–∞–≥–ª': '–ó–¥–æ—Ä–æ–≤–∞—è –≠–∫—Å–ø–∞–Ω—Å–∏—è',
        r'–ª–µ–≥–∫.*—É—Å–ø–µ—Ö': '–ë–µ–∑—É—Å–∏–ª—å–Ω–æ—Å—Ç—å (–£-–≤—ç–π)',
        r'—Ö–æ–ª–æ–¥–Ω': '–ê–≤—Ç–æ–Ω–æ–º–∏—è',
        r'–Ω—ã—Ç—å': '–°—É–±—ä–µ–∫—Ç–Ω–æ—Å—Ç—å',
        r'–±–µ–∑–æ—Ç–≤–µ—Ç': '–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å –∏ –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
        r'–ª–µ–Ω–∏–≤': '–°–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–æ—Ç–æ–∫—É',
        r'—Ç—Ä—É—Å–æ—Å—Ç': '–î–æ–≤–µ—Ä–∏–µ –¥–≤–∏–∂–µ–Ω–∏—é',
        r'–Ω–µ—Ä–µ—à–∏—Ç–µ–ª—å–Ω': '–Ø—Å–Ω–æ—Å—Ç—å –≤—ã–±–æ—Ä–∞',
        r'—ç–≥–æ–∏–∑–º': '–£–≤–∞–∂–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü',
        r'–≥—Ä—É–±–æ—Å—Ç': '–°–∏–ª–∞ —Å —É–≤–∞–∂–µ–Ω–∏–µ–º',
        r'–ª–∂–∏–≤–æ—Å—Ç': '–ü—Ä–∞–≤–¥–∏–≤–æ—Å—Ç—å',
        r'–ø—Ä–µ–¥–∞—Ç–µ–ª—å—Å—Ç–≤': '–í–µ—Ä–Ω–æ—Å—Ç—å —Å–µ–±–µ',
        r'–∏—Å—Ç–µ—Ä–∏–∫': '–ì–ª—É–±–æ–∫–æ–µ —á—É–≤—Å—Ç–≤–æ–≤–∞–Ω–∏–µ',
        r'–∞–≥—Ä–µ—Å—Å–∏': '–ó–∞—â–∏—Ç–∞ —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π',
        r'—Ä–∞–≤–Ω–æ–¥—É—à–∏': '–ü–æ–ª–Ω–æ–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ',
        r'—Ü–∏–Ω–∏–∑–º': '–í–∏–¥–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π',
        r'–ø–µ—Å—Å–∏–º–∏–∑–º': '–ó–∞–º–µ—á–∞–Ω–∏–µ —Å–≤–µ—Ç–∞',
        r'–∑–∞–≤–∏—Å—Ç': '–°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–æ—Ü–≤–µ—Ç–∞–Ω–∏–µ',
        r'—Ö–≤–∞—Å—Ç–æ–≤—Å—Ç–≤': '–ü—Ä–∏–∑–Ω–∞–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π',
        r'–º–∞–Ω–∏–ø—É–ª—è—Ü': '–ü—Ä—è–º–æ–µ –æ–±—â–µ–Ω–∏–µ',
        r'–ø–∞—Å—Å–∏–≤–Ω': '–û—Å–æ–∑–Ω–∞–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ',
        r'–∂–µ—Å—Ç–æ–∫–æ—Å—Ç': '–¢–≤–µ—Ä–¥–æ—Å—Ç—å —Å –∑–∞–±–æ—Ç–æ–π'
    }
    
    for pattern, resource in resource_map.items():
        if re.search(pattern, text_lower):
            return resource
    
    if any(word in text_lower for word in ['–±–µ—Å–∏—Ç', '—Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç', '–∑–ª–∏—Ç', '–Ω–µ –ª—é–±–ª—é', '–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è']):
        return '–ì–∞—Ä–º–æ–Ω–∏—á–Ω–∞—è –°–∏–ª–∞'
    
    return '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –°–≤–æ–±–æ–¥–∞'

def analyze_idle_thoughts(text: str) -> str:
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ö–æ–ª–æ—Å—Ç–æ–π —Ö–æ–¥ (–æ—Ç–≤–µ—Ç –Ω–∞ –®–∞–≥ 3)"""
    if not text:
        return "–ú—ã—Å–ª–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –∑–∞—Ü–∏–∫–ª–µ–Ω –Ω–∞ —Ñ–æ–Ω–æ–≤—ã—Ö —Å–æ–º–Ω–µ–Ω–∏—è—Ö. –£—Ç–∏–ª–∏–∑–∞—Ü–∏—è —ç–Ω–µ—Ä–≥–∏–∏: 80%."
    
    text_lower = text.lower()
    
    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã —Ö–æ–ª–æ—Å—Ç–æ–≥–æ —Ö–æ–¥–∞
    patterns = {
        r'–∞ –≤–¥—Ä—É–≥': '—Ü–∏–∫–ª "–∞ –≤–¥—Ä—É–≥"',
        r'–∞ –µ—Å–ª–∏': '—Ü–∏–∫–ª "–∞ –µ—Å–ª–∏"',
        r'—á—Ç–æ –µ—Å–ª–∏': '—Ü–∏–∫–ª "—á—Ç–æ –µ—Å–ª–∏"',
        r'—Å–æ–º–Ω–µ–Ω': '–±–ª–æ–∫ —Å–æ–º–Ω–µ–Ω–∏–π',
        r'—Å—Ç—Ä–∞—Ö': '–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä —Å—Ç—Ä–∞—Ö–∞',
        r'–±–æ—é—Å—å': '–º–æ–¥—É–ª—å —Å—Ç—Ä–∞—Ö–∞',
        r'–ø–µ—Ä–µ–∂–∏–≤–∞—é': '–ø–µ—Ä–µ–∂–∏–≤–∞—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç—É—Ä',
        r'–≤–æ–ª–Ω—É—é—Å—å': '–≤–æ–ª–Ω–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å',
        r'–Ω–µ —É–≤–µ—Ä–µ–Ω': '–∫–æ–Ω—Ç—É—Ä –Ω–µ—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏',
        r'–Ω–µ –∑–Ω–∞—é': '–ø—Ä–æ—Ü–µ—Å—Å –Ω–µ–∑–Ω–∞–Ω–∏—è',
        r'—á—Ç–æ —Å–∫–∞–∂—É—Ç': '—Å–æ—Ü–∏–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä',
        r'–º–Ω–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö': '–≤–Ω–µ—à–Ω–µ–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç—É—Ä',
        r'–Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è': '–ø—Ä–æ–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ–π',
        r'–ø—Ä–æ–≤–∞–ª': '–∞–Ω—Ç–∏—Ü–∏–ø–∞—Ü–∏—è –ø—Ä–æ–≤–∞–ª–∞',
        r'–Ω–µ —Å–ø—Ä–∞–≤–ª—é—Å—å': '–∫–æ–Ω—Ç—É—Ä –ø–µ—Ä–µ–æ—Ü–µ–Ω–∫–∏',
        r'–¥–æ–ª–∂–µ–Ω': '–¥–æ–ª–∂–µ–Ω—Å—Ç–≤–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –¥—Ä–∞–π–≤–µ—Ä',
        r'–Ω–∞–¥–æ': '–æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å',
        r'–æ–±—è–∑–∞–Ω': '–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å'
    }
    
    detected_patterns = []
    for pattern, label in patterns.items():
        if re.search(pattern, text_lower):
            detected_patterns.append(label)
    
    if detected_patterns:
        patterns_text = ', '.join(detected_patterns[:3])
        return f"{patterns_text} —É—Ç–∏–ª–∏–∑–∏—Ä—É—é—Ç 80% —ç–Ω–µ—Ä–≥–∏–∏. –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä –∑–∞—Ü–∏–∫–ª–µ–Ω –Ω–∞ —ç—Ç–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–∞—Ö, —Å–æ–∑–¥–∞–≤–∞—è —Ö–æ–ª–æ—Å—Ç–æ–π —Ö–æ–¥ –±–µ–∑ –¥–≤–∏–∂–µ–Ω–∏—è."
    else:
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—â–∏–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –º—ã—Å–ª–µ–π
        if len(text_lower.split()) > 15:
            return "–ò–∑–±—ã—Ç–æ—á–Ω—ã–π –º—ã—Å–ª–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å —É—Ç–∏–ª–∏–∑–∏—Ä—É–µ—Ç 80% —ç–Ω–µ—Ä–≥–∏–∏. –ú–æ–∑–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Ö–æ–ª–æ—Å—Ç–æ–º —Ö–æ–¥—É –±–µ–∑ –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏."
        else:
            return "–§–æ–Ω–æ–≤—ã–µ –º—ã—Å–ª–∏ —Å–æ–∑–¥–∞—é—Ç —Ö–æ–ª–æ—Å—Ç–æ–π —Ü–∏–∫–ª –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞. –£—Ç–∏–ª–∏–∑–∞—Ü–∏—è —ç–Ω–µ—Ä–≥–∏–∏: 80%."

def synthesize_meta_beacon(step2_text: str, shadow_resource: str) -> str:
    """–°–∏–Ω—Ç–µ–∑–∏—Ä—É–µ—Ç –ú–µ—Ç–∞-–º–∞—è–∫ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è –®–∞–≥–∞ 2 –∏ —Ä–µ—Å—É—Ä—Å–∞ –®–∞–≥–∞ 6"""
    filtered_state = filter_step2_response(step2_text)
    
    if filtered_state == "–°–æ—Å—Ç–æ—è–Ω–∏–µ–ê–≤—Ç–æ—Ä–∞":
        role_base = "–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä"
    else:
        role_base = filtered_state.replace("—Å–æ—Å—Ç–æ—è–Ω–∏–µ", "").strip()
        if not role_base:
            role_base = "–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä"
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –∏–∑ —Ä–µ—Å—É—Ä—Å–∞
    resource_words = shadow_resource.split()
    if resource_words:
        resource_key = resource_words[0]
    else:
        resource_key = "–°–≤–æ–±–æ–¥–Ω—ã–π"
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–æ–ª—å
    if role_base in ["–°–≤–æ–±–æ–¥–∞", "–°–≤–æ–±–æ–¥–Ω—ã–π", "–°–≤–æ–±–æ–¥–Ω–æ"]:
        role = f"{resource_key} –¢–≤–æ—Ä–µ—Ü"
    elif role_base in ["–ú–æ—â—å", "–ú–æ—â–Ω—ã–π", "–°–∏–ª–∞"]:
        role = f"{resource_key} –î–≤–∏–≥–∞—Ç–µ–ª—å"
    elif role_base in ["–Ø—Å–Ω–æ—Å—Ç—å", "–Ø—Å–Ω—ã–π", "–ß–µ—Ç–∫–æ—Å—Ç—å"]:
        role = f"{resource_key} –ù–∞–≤–∏–≥–∞—Ç–æ—Ä"
    elif role_base in ["–†–∞–¥–æ—Å—Ç—å", "–†–∞–¥–æ—Å—Ç–Ω—ã–π", "–°—á–∞—Å—Ç—å–µ"]:
        role = f"{resource_key} –°–æ–∑–¥–∞—Ç–µ–ª—å"
    else:
        role = f"{resource_key} {role_base}"
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è
    if filtered_state != "–°–æ—Å—Ç–æ—è–Ω–∏–µ–ê–≤—Ç–æ—Ä–∞" and filtered_state.lower() not in role.lower():
        if len(role.split()) < 4:  # –ù–µ –¥–µ–ª–∞–µ–º —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–º
            role = f"{role} –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ {filtered_state}"
    
    return role

def extract_physical_marker(text: str) -> str:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –º–∞—Ä–∫–µ—Ä –∏–∑ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –®–∞–≥ 5"""
    if not text:
        return "—Å–∂–∞—Ç–∏–µ –≤ —Å–æ–ª–Ω–µ—á–Ω–æ–º —Å–ø–ª–µ—Ç–µ–Ω–∏–∏"
    
    text_lower = text.lower()
    
    patterns = [
        r'—Å–∂–∞—Ç–∏[–µ—è].*?(?:–≤|—É)\s*(?:–≥–æ—Ä–ª[–µ–∞]|–≥—Ä—É–¥[–∏—å–µ]|—Å–æ–ª–Ω–µ—á–Ω[–∞-—è]*|–∂–∏–≤–æ—Ç[–∞–µ])',
        r'–∫–æ–º.*?(?:–≤|—É)\s*(?:–≥–æ—Ä–ª[–µ–∞])',
        r'—Ö–æ–ª–æ–¥.*?(?:–≤|—É)\s*(?:–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—è—Ö|–≥—Ä—É–¥[–∏—å–µ]|—Å–ø–∏–Ω[–µ–∞])',
        r'—Ç—è–∂–µ—Å—Ç[–∏—å].*?(?:–≤|—É)\s*(?:–ø–ª–µ—á–∞—Ö|—à–µ–µ|–≥—Ä—É–¥[–∏—å–µ]|–≥–æ–ª–æ–≤–µ)',
        r'–Ω–∞–ø—Ä—è–∂–µ–Ω–∏[–µ—è].*?(?:–≤|—É)\s*(?:—à–µ–µ|—á–µ–ª—é—Å—Ç[–∏—è]|–ø–ª–µ—á–∞—Ö|–ª–±—É)',
        r'–ø—É—Å—Ç–æ—Ç[–∞—ã—É].*?(?:–≤|—É)\s*(?:–≥—Ä—É–¥[–∏—å–µ]|–∂–∏–≤–æ—Ç[–µ–∞]|–≥–æ–ª–æ–≤–µ)',
        r'–∂–∂–µ–Ω–∏[–µ—è].*?(?:–≤|—É)\s*(?:–≥—Ä—É–¥[–∏—å–µ]|—Å–æ–ª–Ω–µ—á–Ω[–∞-—è]*|–∂–∏–≤–æ—Ç[–µ–∞])',
        r'–¥—Ä–æ–∂[—å–∏].*?(?:–≤|—É)\s*(?:—Ç–µ–ª–µ|—Ä—É–∫–∞—Ö|–Ω–æ–≥–∞—Ö|–∫–æ–ª–µ–Ω—è—Ö)',
        r'–¥–∞–≤–ª–µ–Ω–∏[–µ—è].*?(?:–≤|—É)\s*(?:–≥—Ä—É–¥[–∏—å–µ]|–≥–æ–ª–æ–≤–µ|–≤–∏—Å–∫–∞—Ö)',
        r'—Ç–µ–ø–ª[–æ–∞].*?(?:–≤|—É)\s*(?:–≥—Ä—É–¥[–∏—å–µ]|–∂–∏–≤–æ—Ç[–µ–∞])',
        r'–º—É—Ä–∞—à–∫[–∏].*?(?:–ø–æ|–≤)\s*(?:—Å–ø–∏–Ω[–µ–∞]|—Ä—É–∫–∞–º)',
        r'–æ–Ω–µ–º–µ–Ω–∏[–µ—è].*?(?:–≤|—É)\s*(?:–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—è—Ö|–ª–∏—Ü–µ)',
        r'–ø–æ–∫–∞–ª—ã–≤–∞–Ω–∏[–µ—è].*?(?:–≤|—É)\s*(?:–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—è—Ö|–ª–∏—Ü–µ)'
    ]
    
    for pattern in patterns:
        match = re.search(pattern, text_lower)
        if match:
            marker = match.group(0)
            if marker and not marker[0].isupper():
                marker = marker[0].upper() + marker[1:]
            return marker
    
    keywords = ['—Å–∂–∞—Ç–∏–µ', '–∫–æ–º', '—Ö–æ–ª–æ–¥', '—Ç—è–∂–µ—Å—Ç—å', '–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ', 
               '–ø—É—Å—Ç–æ—Ç–∞', '–∂–∂–µ–Ω–∏–µ', '–¥—Ä–æ–∂—å', '–¥–∞–≤–ª–µ–Ω–∏–µ', '–±–æ–ª—å', 
               '–¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç', '—Ç–µ–ø–ª–æ', '–º—É—Ä–∞—à–∫–∏', '–æ–Ω–µ–º–µ–Ω–∏–µ', '–ø–æ–∫–∞–ª—ã–≤–∞–Ω–∏–µ']
    
    for keyword in keywords:
        if keyword in text_lower:
            return f"{keyword} –≤ —Ç–µ–ª–µ"
    
    return "—Å–∂–∞—Ç–∏–µ –≤ —Å–æ–ª–Ω–µ—á–Ω–æ–º —Å–ø–ª–µ—Ç–µ–Ω–∏–∏"

def calculate_system_stagnation(answers: list) -> int:
    """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –∑–∞—Å—Ç–æ—è"""
    if not answers or len(answers) < 3:
        return 65
    
    text = ' '.join(answers[:5]).lower()
    
    stagnation_markers = [
        r'–Ω–µ\s+–º–æ–≥—É', r'–Ω–µ\s+–ø–æ–ª—É—á–∞–µ—Ç—Å—è', r'–Ω–µ\s+–∑–Ω–∞—é', 
        r'–∑–∞—Å—Ç—Ä—è[–ª–Ω][–∞–æ–∏]?', r'–±—É–∫—Å—É—é', r'—Å—Ç–æ—é\s+–Ω–∞\s+–º–µ—Å—Ç–µ',
        r'–±–æ—é—Å—å', r'—Å—Ç—Ä–∞—à–Ω–æ', r'—Å–æ–º–Ω–µ–≤–∞—é—Å—å', r'–∞\s+–≤–¥—Ä—É–≥',
        r'–¥–æ–ª–∂–µ–Ω', r'–Ω–∞–¥–æ', r'–æ–±—è–∑–∞–Ω', r'–≤—ã–Ω—É–∂–¥–µ–Ω',
        r'–ø—Ä–æ–±–ª–µ–º[–∞—ã—É–µ]', r'—Ç—Ä—É–¥–Ω–æ—Å—Ç[–∏—å]', r'–ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏[–µ—è]',
        r'–Ω–µ–≤–æ–∑–º–æ–∂–Ω', r'—Å–ª–æ–∂–Ω', r'—Ç—è–∂–µ–ª'
    ]
    
    movement_markers = [
        r'–º–æ–≥—É', r'—Ö–æ—á—É', r'–±—É–¥—É', r'—Å–¥–µ–ª–∞—é',
        r'—Ä–µ—à–∞—é', r'–≤—ã–±–∏—Ä–∞—é', r'—Å–æ–∑–¥–∞—é',
        r'–≤–µ—Ä—é', r'–¥–æ–≤–µ—Ä—è—é', r'—á—É–≤—Å—Ç–≤—É—é\s+—Å–∏–ª—É',
        r'–ª–µ–≥–∫–æ', r'—Å–≤–æ–±–æ–¥–Ω–æ', r'—è—Å–Ω–æ', r'–ø—Ä–æ—Å—Ç–æ',
        r'–∏–Ω—Ç–µ—Ä–µ—Å–Ω', r'—Ä–∞–¥–æ—Å—Ç–Ω', r'—É–≤–µ—Ä–µ–Ω'
    ]
    
    stagnation_count = 0
    movement_count = 0
    
    for marker in stagnation_markers:
        stagnation_count += len(re.findall(marker, text))
    
    for marker in movement_markers:
        movement_count += len(re.findall(marker, text))
    
    total = stagnation_count + movement_count + 1
    stagnation_percentage = (stagnation_count / total) * 100
    
    level = min(90, max(30, int(stagnation_percentage)))
    
    # –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–ª–∏–Ω—ã –æ—Ç–≤–µ—Ç–æ–≤
    avg_length = sum(len(a) for a in answers[:3]) / 3 if len(answers) >= 3 else 50
    if avg_length < 20:  # –ö–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã - –≤—ã—à–µ –∑–∞—Å—Ç–æ–π
        level = min(90, level + 10)
    elif avg_length > 100:  # –î–ª–∏–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã - –∞–Ω–∞–ª–∏–∑ —Å–ª–æ–∂–Ω–µ–µ
        level = max(30, level - 5)
    
    return level

def generate_metaformula(step5_text: str, synthesized_role: str) -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –º–µ—Ç–∞—Ñ–æ—Ä–º—É–ª—É"""
    physical_marker = extract_physical_marker(step5_text)
    
    if not physical_marker[0].isupper():
        physical_marker = physical_marker[0].upper() + physical_marker[1:]
    
    return f"–Ø –ê–≤—Ç–æ—Ä. –ü–†–ò–ó–ù–ê–Æ {physical_marker} –∏ –í–´–ë–ò–†–ê–Æ –±—ã—Ç—å {synthesized_role}"

# --- –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –§–û–õ–ë–≠–ö –û–¢–ß–ï–¢–ê ---
def generate_fallback_report(answers: list) -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ñ–æ–ª–±—ç–∫ –æ—Ç—á–µ—Ç –ø–æ –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ"""
    if len(answers) < 8:
        answers = answers + [""] * (8 - len(answers))
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    area = answers[0][:50] if answers[0] else "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å"
    step2_state = filter_step2_response(answers[1])
    idle_analysis = analyze_idle_thoughts(answers[2])
    blockage_image = answers[3][:50] if answers[3] else "–±–ª–æ–∫–∏—Ä—É—é—â–∏–π –æ–±—ä–µ–∫—Ç"
    physical_marker = extract_physical_marker(answers[4])
    shadow_resource = decode_shadow_resource(answers[5] if len(answers) > 5 else "")
    
    # –°–∏–Ω—Ç–µ–∑–∏—Ä—É–µ–º –ú–µ—Ç–∞-–º–∞—è–∫
    synthesized_role = synthesize_meta_beacon(answers[1], shadow_resource)
    
    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –∑–∞—Å—Ç–æ—è
    stagnation_level = calculate_system_stagnation(answers)
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –º–µ—Ç–∞—Ñ–æ—Ä–º—É–ª—É
    metaformula = generate_metaformula(answers[4], synthesized_role)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç
    report = f"""‚¨õÔ∏è [–ü–†–û–¢–û–ö–û–õ –ê–£–î–ò–¢–ê –ê–í–¢–û–ü–ò–õ–û–¢–ê] üìÄ

–°—Ç–∞—Ç—É—Å: –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ç–æ–∫–∞ —ç–Ω–µ—Ä–≥–∏–∏ –≤ –º–æ–¥—É–ª–µ {area}.

üìä –£–†–û–í–ï–ù–¨ –°–ò–°–¢–ï–ú–ù–û–ì–û –ó–ê–°–¢–û–Ø: {stagnation_level}%

üß† –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ö–û–ù–¢–£–†–û–í:

–£–ó–ï–õ –°–û–ü–†–û–¢–ò–í–õ–ï–ù–ò–Ø: –û–±—Ä–∞–∑ "{blockage_image}" –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤–∞—à–µ –¥–≤–∏–∂–µ–Ω–∏–µ, –≤—ã–∑—ã–≤–∞—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –º–∞—Ä–∫–µ—Ä {physical_marker}.

–•–û–õ–û–°–¢–û–ô –•–û–î (–†–ï–ñ–ò–ú –ó–ê–°–¢–ê–í–ö–ò): {idle_analysis}

–†–ï–ê–ö–¢–û–† –ò–î–ï–ù–¢–ò–ß–ù–û–°–¢–ò (–°–ö–†–´–¢–´–ô –†–ï–°–£–†–°): {shadow_resource}.

–ú–ï–¢–ê-–ú–ê–Ø–ö (–≠–¢–ê–õ–û–ù): {synthesized_role}.

‚ö°Ô∏è –í–ê–®–ê –ú–ï–¢–ê–§–û–†–ú–£–õ–ê (–ö–û–î –ê–ö–¢–ò–í–ê–¶–ò–ò): {metaformula}

[–î–ò–†–ï–ö–¢–ò–í–ê]: –ö–æ–¥ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –í–∏–¥–µ–æ-–ø—Ä–∞–∫—Ç–∏–∫—É–º—É –Ω–∏–∂–µ –¥–ª—è –µ–≥–æ –∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏–∏."""
    
    return report

# --- –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò –ì–ê–ô–î–ê (–ö–û–†–û–¢–ö–ê–Ø –í–ï–†–°–ò–Ø) ---
async def download_and_send_pdf(message: types.Message):
    """–°–∫–∞—á–∏–≤–∞–µ—Ç PDF –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ —Å –∫—Ä–∞—Ç–∫–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ–º"""
    try:
        await message.answer("üì• **–ó–∞–≥—Ä—É–∂–∞—é –≤–∞—à –ø—Ä–æ—Ç–æ–∫–æ–ª...**", parse_mode="Markdown")
        
        async with ClientSession() as session:
            async with session.get(GUIDE_URL) as response:
                if response.status != 200: 
                    raise Exception(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: {response.status}")
                pdf_data = await response.read()
        
        caption_text = (
            "üìò –ü—Ä–æ—Ç–æ–∫–æ–ª ¬´–î–µ—à–∏—Ñ—Ä–æ–≤–∫–∞ –ê–≤—Ç–æ–ø–∏–ª–æ—Ç–∞¬ª\n\n"
            "–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–µ—Ä–µ–ø—Ä–æ—à–∏–≤–∫–∏:\n"
            "‚Ä¢ –§–∏–∑–∏–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞—Å—Ç–æ–µ–≤\n"
            "‚Ä¢ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è –í–Ω–µ—à–Ω–µ–≥–æ –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—è\n"
            "‚Ä¢ –ü—Ä–∏–Ω—Ü–∏–ø –ó–µ—Ä–∫–∞–ª–∞\n"
            "‚Ä¢ –ú–µ—Ö–∞–Ω–∏–∫–∞ –ú–µ—Ç–∞—Ñ–æ—Ä–º—É–ª—ã\n\n"
            "–ò–Ω—Å—Ç–∞–ª–ª—è—Ü–∏–æ–Ω–Ω—ã–π –ø–∞–∫–µ—Ç."
        )

        await message.answer_document(
            document=types.BufferedInputFile(pdf_data, filename=GUIDE_FILENAME),
            caption=caption_text,
            parse_mode="Markdown"
        )
        return True
    except Exception as e:
        logger.error(f"PDF Error: {e}")
        await message.answer(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞. –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞: {GUIDE_URL}")
        return False

# --- –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò –°–û–û–ë–©–ï–ù–ò–Ø –û –°–î–í–ò–ì–ï –ö –ú–ö ---
async def send_mk_shift_message(message: types.Message):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–¥–≤–∏–≥–µ –∫ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—É —á–µ—Ä–µ–∑ –∑–∞–¥–µ—Ä–∂–∫—É"""
    await asyncio.sleep(30)
    
    try:
        builder = InlineKeyboardBuilder()
        builder.row(
            types.InlineKeyboardButton(
                text='üé¨ –ê–ö–¢–ò–í–ò–†–û–í–ê–¢–¨ –†–ï–ñ–ò–ú –ê–í–¢–û–†–ê ‚Äî 990 —Ä.',
                url=MASTERCLASS_URL
            )
        )
        
        mk_message = (
            "üéØ –ê—É–¥–∏—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –ö–æ–¥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω.\n\n"
            "–í—ã –ø–æ–ª—É—á–∏–ª–∏ —Å–≤–æ—é –ú–µ—Ç–∞—Ñ–æ—Ä–º—É–ª—É ‚Äî —Å–∏—Å—Ç–µ–º–Ω—ã–π –∫–ª—é—á –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è. "
            "–î–ª—è –ø–æ–ª–Ω–æ–π –∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏–∏ –∫–æ–¥–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è –ê—É–¥–∏–æ-–∫–æ–¥–∞ ¬´–ü–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫¬ª, –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ø–∞–∫–µ—Ç:\n\n"
            "‚Ä¢ üé¨ –í–∏–¥–µ–æ-–ø—Ä–∞–∫—Ç–∏–∫—É–º ¬´–ö–û–î –ú–ï–¢–ê–§–û–†–ú–£–õ–´¬ª\n"
            "‚Ä¢ –ê—É–¥–∏–æ-–∫–æ–¥ ¬´–ü–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫ –ê–≤—Ç–æ–ø–∏–ª–æ—Ç–∞¬ª\n"
            "‚Ä¢ –ü—Ä–æ—Ç–æ–∫–æ–ª –æ—Ç–ª–∞–¥–∫–∏ (—Ä–∞–±–æ—á–∞—è —Ç–µ—Ç—Ä–∞–¥—å)"
        )
        
        await message.answer(
            mk_message,
            parse_mode="Markdown",
            reply_markup=builder.as_markup()
        )
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ MK —Å–¥–≤–∏–≥–∞: {e}")

# --- –§–£–ù–ö–¶–ò–Ø –ü–†–û–í–ï–†–ö–ò –ü–û–î–ü–ò–°–ö–ò ---
async def is_subscribed(user_id: int) -> bool:
    try:
        member = await bot.get_chat_member(chat_id=CHANNEL_ID, user_id=user_id)
        return member.status in ["member", "administrator", "creator"]
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏: {e}")
        return False

# --- –°–ò–°–¢–ï–ú–ê –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê ---
async def send_admin_alert(alert_type: str, details: str, tb: str = ""):
    global error_counter, api_failures
    try:
        ts = datetime.now().strftime("%d.%m %H:%M:%S")
        
        msg = f"üö® –°–ò–ì–ù–ê–õ: {alert_type.upper()}\n\n"
        msg += f"‚è∞ –í—Ä–µ–º—è: {ts}\n"
        msg += f"üìù –î–µ—Ç–∞–ª–∏: {details}\n"
        
        if tb:
            if len(tb) > 1000:
                msg += f"\nüîß –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞: (–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–º —Ñ–∞–π–ª–æ–º)"
                
                await bot.send_document(
                    chat_id=ADMIN_ID,
                    document=types.BufferedInputFile(
                        tb.encode('utf-8'),
                        filename=f"traceback_{ts.replace(':', '-').replace(' ', '_')}.txt"
                    ),
                    caption=f"–¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –æ—à–∏–±–∫–∏: {alert_type}"
                )
            else:
                msg += f"\nüîß –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞:\n{tb[:800]}"
        
        msg += f"\n\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –û—à–∏–±–æ–∫: {error_counter} | –°–±–æ–µ–≤ API: {api_failures}"
        
        await bot.send_message(chat_id=ADMIN_ID, text=msg)
    except Exception as e:
        logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–ª–µ—Ä—Ç: {e}")

async def send_admin_copy(user: types.User, answers: list, report: str):
    try:
        user_info = f"üë§ {user.full_name} (@{user.username})"
        text_answers = "\n".join([f"{i+1}. {a}" for i, a in enumerate(answers)])
        
        full_log = (
            "üîî –ù–û–í–´–ô –ê–£–î–ò–¢ –ó–ê–í–ï–†–®–ï–ù\n\n"
            f"{user_info}\n\n"
            "üìù –û—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n"
            f"{text_answers}\n\n"
            "üß† –û—Ç—á–µ—Ç –ò–ò:\n"
            f"{report}"
        )
        
        if len(full_log) > 4000:
            await bot.send_message(chat_id=ADMIN_ID, text=full_log[:4000])
            await bot.send_message(chat_id=ADMIN_ID, text=full_log[4000:8000] if len(full_log) > 8000 else full_log[4000:])
        else:
            await bot.send_message(chat_id=ADMIN_ID, text=full_log)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ª–æ–≥–∞ –∞–¥–º–∏–Ω—É: {e}")

# --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ---
@dp.message(Command("start"))
async def cmd_start(message: types.Message, state: FSMContext):
    await state.clear()
    try:
        is_sub = await is_subscribed(message.from_user.id)
        
        if not is_sub:
            welcome = WELCOME_MESSAGES["not_subscribed"]
            builder = InlineKeyboardBuilder()
            builder.row(types.InlineKeyboardButton(text="–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –ø—Ä–æ–µ–∫—Ç—É", url=CHANNEL_URL))
            builder.row(types.InlineKeyboardButton(text="–Ø –≤ –∫–∞–Ω–∞–ª–µ! –ù–∞—á–∞—Ç—å –ê—É–¥–∏—Ç", callback_data="check_sub"))
            
            await message.answer_photo(
                photo=welcome["logo"],
                caption=f"**{welcome['title']}**\n\n{welcome['text']}",
                reply_markup=builder.as_markup(),
                parse_mode="Markdown"
            )
        else:
            welcome = WELCOME_MESSAGES["subscribed"]
            builder = InlineKeyboardBuilder()
            builder.row(types.InlineKeyboardButton(text="üöÄ –ù–∞—á–∞—Ç—å –ê—É–¥–∏—Ç –ê–≤—Ç–æ–ø–∏–ª–æ—Ç–∞", callback_data="start_audit"))
            
            await message.answer_photo(
                photo=welcome["logo"],
                caption=f"**{welcome['title']}**\n\n{welcome['text']}",
                reply_markup=builder.as_markup(),
                parse_mode="Markdown"
            )
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ /start: {e}")
        await send_admin_alert("start_error", str(e), traceback.format_exc())
        await message.answer("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

@dp.callback_query(F.data == "check_sub")
async def handle_sub_check(callback: types.CallbackQuery, state: FSMContext):
    await callback.answer("–ü—Ä–æ–≤–µ—Ä—è—é –ø–æ–¥–ø–∏—Å–∫—É...")
    try:
        await asyncio.sleep(0.5)
        is_sub = await is_subscribed(callback.from_user.id)
        
        if is_sub:
            welcome = WELCOME_MESSAGES["subscribed"]
            builder = InlineKeyboardBuilder()
            builder.row(types.InlineKeyboardButton(text="üöÄ –ù–∞—á–∞—Ç—å –ê—É–¥–∏—Ç –ê–≤—Ç–æ–ø–∏–ª–æ—Ç–∞", callback_data="start_audit"))
            
            try:
                await callback.message.edit_media(
                    media=types.InputMediaPhoto(
                        media=welcome["logo"],
                        caption=f"**{welcome['title']}**\n\n{welcome['text']}",
                        parse_mode="Markdown"
                    ),
                    reply_markup=builder.as_markup()
                )
            except:
                await callback.message.answer_photo(
                    photo=welcome["logo"],
                    caption=f"**{welcome['title']}**\n\n{welcome['text']}",
                    reply_markup=builder.as_markup(),
                    parse_mode="Markdown"
                )
        else:
            builder = InlineKeyboardBuilder()
            builder.row(types.InlineKeyboardButton(text="üì¢ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª", url=CHANNEL_URL))
            builder.row(types.InlineKeyboardButton(text="‚úÖ –Ø —É–∂–µ –ø–æ–¥–ø–∏—Å–∞–ª—Å—è", callback_data="check_sub_again"))
            
            await callback.message.answer(
                "‚ùå **–í—ã –µ—â–µ –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ –∫–∞–Ω–∞–ª!**\n\n–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∞—É–¥–∏—Ç—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è.",
                reply_markup=builder.as_markup(),
                parse_mode="Markdown"
            )
            await callback.answer("–í—ã –µ—â–µ –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã!", show_alert=True)
                
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏: {e}")
        await callback.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–¥–ø–∏—Å–∫–∏", show_alert=True)

@dp.callback_query(F.data == "check_sub_again")
async def handle_sub_check_again(callback: types.CallbackQuery):
    await callback.answer("–ü—Ä–æ–≤–µ—Ä—è—é –µ—â–µ —Ä–∞–∑...")
    try:
        is_sub = await is_subscribed(callback.from_user.id)
        
        if is_sub:
            welcome = WELCOME_MESSAGES["subscribed"]
            builder = InlineKeyboardBuilder()
            builder.row(types.InlineKeyboardButton(text="üöÄ –ù–∞—á–∞—Ç—å –ê—É–¥–∏—Ç –ê–≤—Ç–æ–ø–∏–ª–æ—Ç–∞", callback_data="start_audit"))
            
            try:
                await callback.message.delete()
            except:
                pass
                
            await callback.message.answer_photo(
                photo=welcome["logo"],
                caption=f"**{welcome['title']}**\n\n{welcome['text']}",
                reply_markup=builder.as_markup(),
                parse_mode="Markdown"
            )
        else:
            await callback.answer("‚ùå –í—ã –≤—Å–µ –µ—â–µ –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã!", show_alert=True)
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏: {e}")
        await callback.answer("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏", show_alert=True)

@dp.callback_query(F.data == "start_audit")
async def start_audit_flow(callback: types.CallbackQuery, state: FSMContext):
    await callback.answer("–ó–∞–ø—É—Å–∫–∞—é –∞—É–¥–∏—Ç...")
    try:
        if not await is_subscribed(callback.from_user.id):
            await callback.answer("‚ùå –í—ã –æ—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç –∫–∞–Ω–∞–ª–∞!", show_alert=True)
            return
        
        await state.update_data(current_step=0, answers=[])
        
        await callback.message.answer(
            "üî¨ **–ó–ê–ü–£–°–ö –ü–†–û–¢–û–ö–û–õ–ê –ê–£–î–ò–¢–ê –ê–í–¢–û–ü–ò–õ–û–¢–ê**\n\n"
            "–°–∫–∞–Ω–∏—Ä—É—é 8 —Ç–æ—á–µ–∫ –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∏:\n"
            "1. –õ–æ–∫–∞—Ü–∏—è –∑–∞—Å—Ç–æ—è\n"
            "2. –û–±—Ä–∞–∑ –±—É–¥—É—â–µ–≥–æ\n"
            "3. –•–æ–ª–æ—Å—Ç–æ–π —Ö–æ–¥\n"
            "4. –ó–∞—â–∏—Ç–Ω—ã–π –∫–æ–Ω—Ç—É—Ä\n"
            "5. –°–µ–Ω—Å–æ—Ä–Ω—ã–π –º–∞—Ä–∫–µ—Ä\n"
            "6. –¢–µ–Ω–µ–≤–æ–π —Ä–µ—Å—É—Ä—Å\n"
            "7. –¶–µ–Ω–∞ –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è\n"
            "8. –ò–º—è –†–æ–ª–∏\n\n"
            "–û—Ç–≤–µ—á–∞–π—Ç–µ —á–µ—Å—Ç–Ω–æ ‚Äî —ç—Ç–æ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –≤–∞—à —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ö–æ–¥ –ê–∫—Ç–∏–≤–∞—Ü–∏–∏.",
            parse_mode="Markdown"
        )
        
        await asyncio.sleep(1)
        await callback.message.answer(f"üìç –¢–æ—á–∫–∞ 1 –∏–∑ {len(QUESTIONS)}:\n\n{QUESTIONS[0]}")
        await state.set_state(AuditState.answering_questions)
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∞—É–¥–∏—Ç–∞: {e}")
        await send_admin_alert("audit_start_error", str(e), traceback.format_exc())
        await callback.message.answer("‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∞—É–¥–∏—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")

# --- –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ô –û–¢–ü–†–ê–í–ö–ò –ö–ù–û–ü–û–ö ---
async def send_immediate_masterclass_button(message: types.Message):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–Ω–æ–ø–∫–∏ –¥–ª—è –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å–∞ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –≥–∞–π–¥–∞"""
    try:
        builder = InlineKeyboardBuilder()
        
        builder.row(
            types.InlineKeyboardButton(
                text='üé¨ –ó–ê–ë–†–ê–¢–¨ –ü–†–ê–ö–¢–ò–ö–£–ú ¬´–ö–û–î –ú–ï–¢–ê–§–û–†–ú–£–õ–´¬ª', 
                url=MASTERCLASS_URL
            )
        )
        
        builder.row(
            types.InlineKeyboardButton(
                text='üì• –ï–©–ï –†–ê–ó –°–ö–ê–ß–ê–¢–¨ –ì–ê–ô–î',
                callback_data="download_guide_manual"
            )
        )
        
        await message.answer(
            "üéØ **–í–∞—à –∞—É–¥–∏—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –ö–æ–¥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω.**\n\n"
            "–í—ã –ø–æ–ª—É—á–∏–ª–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –ú–µ—Ç–∞—Ñ–æ—Ä–º—É–ª—É. "
            "–≠—Ç–æ –∫–ª—é—á –∫ –ø–µ—Ä–µ–ø—Ä–æ—à–∏–≤–∫–µ –≤–∞—à–µ–≥–æ –ê–≤—Ç–æ–ø–∏–ª–æ—Ç–∞.\n\n"
            "–î–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø–æ–≥—Ä—É–∂–µ–Ω–∏—è –≤ –º–µ—Ç–æ–¥–∏–∫—É –ø–æ–ª—É—á–∏—Ç–µ –≤–∏–¥–µ–æ-–ø—Ä–∞–∫—Ç–∏–∫—É–º:",
            parse_mode="Markdown",
            reply_markup=builder.as_markup()
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–Ω–æ–ø–æ–∫: {e}")
        try:
            await message.answer(
                "üéØ –í–∞—à –∞—É–¥–∏—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –ö–æ–¥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω.\n\n"
                "–î–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø–æ–≥—Ä—É–∂–µ–Ω–∏—è –≤ –º–µ—Ç–æ–¥–∏–∫—É –ø–æ–ª—É—á–∏—Ç–µ –≤–∏–¥–µ–æ-–ø—Ä–∞–∫—Ç–∏–∫—É–º:\n"
                f"{MASTERCLASS_URL}"
            )
        except:
            pass

@dp.callback_query(F.data == "download_guide_manual")
async def handle_manual_download(callback: types.CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä—É—á–Ω–æ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞"""
    await callback.answer("–ó–∞–≥—Ä—É–∂–∞—é –ø—Ä–æ—Ç–æ–∫–æ–ª...")
    
    try:
        await download_and_send_pdf(callback.message)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Ä—É—á–Ω–æ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: {e}")
        await callback.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞", show_alert=True)
        await callback.message.answer(f"üì• –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª:\n{GUIDE_URL}")

# --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–ë–†–ê–ë–û–¢–ö–ò –û–¢–í–ï–¢–û–í ---
@dp.message(AuditState.answering_questions)
async def process_answer(message: types.Message, state: FSMContext):
    global error_counter
    
    try:
        if not message.text or not message.text.strip():
            return await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç.")

        data = await state.get_data()
        step = data.get("current_step", 0)
        user_answers = data.get("answers", [])

        user_answers.append(message.text.strip())
        next_step = step + 1

        if next_step < len(QUESTIONS):
            await state.update_data(current_step=next_step, answers=user_answers)
            await message.answer(f"üìç –¢–æ—á–∫–∞ {next_step + 1} –∏–∑ {len(QUESTIONS)}:\n\n{QUESTIONS[next_step]}")
        else:
            # –§–ò–ù–ê–õ - –û–î–ò–ù –†–ê–ó –û–¢–ü–†–ê–í–õ–Ø–ï–ú –û–¢–ß–ï–¢ –ò PDF
            await state.update_data(answers=user_answers)
            await message.answer("üß† –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é –¥–∞–Ω–Ω—ã–µ —Å –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–º —è–¥—Ä–æ–º...")
            
            try:
                report = await generate_ai_report(user_answers)
                clean_report = clean_report_for_telegram(report)
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –û–î–ò–ù –æ—Ç—á–µ—Ç
                await message.answer(clean_report)
                
                # –°–†–ê–ó–£ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º PDF –ø—Ä–æ—Ç–æ–∫–æ–ª –≤ —á–∞—Ç
                await download_and_send_pdf(message)
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ)
                await send_immediate_masterclass_button(message)
                
                # –ó–ê–ü–£–°–ö–ê–ï–ú –ó–ê–î–ê–ß–£ –û–¢–õ–û–ñ–ï–ù–ù–û–ì–û –°–û–û–ë–©–ï–ù–ò–Ø
                asyncio.create_task(send_mk_shift_message(message))
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–ø–∏—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
                await send_admin_copy(message.from_user, user_answers, clean_report)
                
            except Exception as report_error:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞: {report_error}")
                
                # –§–æ–ª–±—ç–∫ –æ—Ç—á–µ—Ç
                fallback_report = generate_fallback_report(user_answers)
                
                await message.answer(fallback_report)
                await download_and_send_pdf(message)
                await send_immediate_masterclass_button(message)
                
                # –ó–ê–ü–£–°–ö–ê–ï–ú –ó–ê–î–ê–ß–£ –û–¢–õ–û–ñ–ï–ù–ù–û–ì–û –°–û–û–ë–©–ï–ù–ò–Ø –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                asyncio.create_task(send_mk_shift_message(message))
            
            await state.clear()
            
    except Exception as e:
        error_counter += 1
        logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞: {e}")
        await send_admin_alert("process_error", str(e), traceback.format_exc())
        await message.answer(
            "‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –æ—Ç–≤–µ—Ç–∞.\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ –∞—É–¥–∏—Ç –∑–∞–Ω–æ–≤–æ —Å –∫–æ–º–∞–Ω–¥—ã /start"
        )

# --- AI REPORT GENERATION ---
async def generate_ai_report(answers: list):
    global api_failures
    
    if not client:
        # –î–µ–º–æ-—Ä–µ–∂–∏–º –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        try:
            return generate_fallback_report(answers)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ: {e}")
            return generate_fallback_report(answers)
    
    # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ò–ò
    user_input_text = "–û–¢–í–ï–¢–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –ù–ê 8 –¢–û–ß–ï–ö –ê–£–î–ò–¢–ê:\n\n"
    for i, ans in enumerate(answers):
        user_input_text += f"–¢–û–ß–ö–ê {i+1}: {QUESTIONS[i]}\n"
        user_input_text += f"–û–¢–í–ï–¢: {ans}\n\n"
    
    user_input_text += "\n---\n–ü–†–û–í–ï–î–ò –ê–£–î–ò–¢ –ê–í–¢–û–ü–ò–õ–û–¢–ê –ò –°–§–û–†–ú–ò–†–£–ô –û–¢–ß–ï–¢ –ü–û –°–¢–†–û–ì–û–ô –°–¢–†–£–ö–¢–£–†–ï. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –í–ö–õ–Æ–ß–ò –†–ê–ó–î–ï–õ '–•–û–õ–û–°–¢–û–ô –•–û–î (–†–ï–ñ–ò–ú –ó–ê–°–¢–ê–í–ö–ò)'. –°–¢–ò–õ–¨: –ö–ò–ë–ï–†-–ú–ò–°–¢–ò–¶–ò–ó–ú. –ë–ï–ó –ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–ò–• –ö–õ–ò–®–ï."
    
    for attempt in range(3):
        try:
            response = await client.chat.completions.create(
                messages=[
                    {"role": "system", "content": SYSTEM_PROMPT},
                    {"role": "user", "content": user_input_text}
                ],
                model="llama-3.3-70b",
                temperature=0.6,
                max_completion_tokens=2000,
                top_p=0.9
            )
            
            api_failures = 0
            
            if hasattr(response, 'choices') and len(response.choices) > 0:
                choice = response.choices[0]
                if hasattr(choice, 'message') and hasattr(choice.message, 'content'):
                    content = choice.message.content
                    if content:
                        return content
            
            return generate_fallback_report(answers)
            
        except Exception as e:
            api_failures += 1
            logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ {attempt + 1} –Ω–µ —É–¥–∞–ª–∞—Å—å: {e}")
            
            if attempt == 2:
                await send_admin_alert("api_critical", f"3 –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å: {str(e)}")
                return generate_fallback_report(answers)
            
            await asyncio.sleep(2 ** attempt)
    
    return generate_fallback_report(answers)

def clean_report_for_telegram(report: str) -> str:
    """–ü–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—á–µ—Ç–∞ –¥–ª—è Telegram"""
    try:
        if not report:
            return report
        
        # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Ä–∞–∑–¥–µ–ª –•–û–õ–û–°–¢–û–ô –•–û–î –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
        if "–•–û–õ–û–°–¢–û–ô –•–û–î" not in report.upper():
            # –ù–∞–π–¥–µ–º, –≥–¥–µ –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª
            lines = report.split('\n')
            new_lines = []
            
            for i, line in enumerate(lines):
                new_lines.append(line)
                # –ü–æ—Å–ª–µ "–£–∑–µ–ª —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è" –≤—Å—Ç–∞–≤–ª—è–µ–º –•–û–õ–û–°–¢–û–ô –•–û–î
                if "–£–∑–µ–ª —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è" in line and i + 1 < len(lines):
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª
                    next_line = lines[i + 1] if i + 1 < len(lines) else ""
                    if "–•–û–õ–û–°–¢–û–ô –•–û–î" not in next_line.upper() and "–†–ï–ê–ö–¢–û–† –ò–î–ï–ù–¢–ò–ß–ù–û–°–¢–ò" not in next_line.upper():
                        # –í—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–≥–ª—É—à–∫—É –¥–ª—è —Ö–æ–ª–æ—Å—Ç–æ–≥–æ —Ö–æ–¥–∞
                        new_lines.append("\n–•–û–õ–û–°–¢–û–ô –•–û–î (–†–ï–ñ–ò–ú –ó–ê–°–¢–ê–í–ö–ò): –§–æ–Ω–æ–≤—ã–µ –º—ã—Å–ª–∏ —Å–æ–∑–¥–∞—é—Ç —Ö–æ–ª–æ—Å—Ç–æ–π —Ü–∏–∫–ª –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞. –£—Ç–∏–ª–∏–∑–∞—Ü–∏—è —ç–Ω–µ—Ä–≥–∏–∏: 80%.")
            
            report = '\n'.join(new_lines)
        
        # –£–±–∏—Ä–∞–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞ (–∫—Ä–æ–º–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤)
        report = re.sub(r'\b(?!API|AI|URL|PDF|MK\b)[a-zA-Z]+\b', '', report)
        
        # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∫—Ä–∏–≤—ã–µ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
        grammar_fixes = {
            r'—Å—Ç—É–ø–∏—Ç—å –Ω–∞ –ø—Ä–∏–º–µ–Ω—è—Ç—å': '–Ω–∞—á–∞—Ç—å –ø—Ä–∏–º–µ–Ω—è—Ç—å',
            r'–∏–º–µ–µ—Ç–µ —Å–∏–ª—É —Å—Ç—É–ø–∏—Ç—å': '–º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å',
            r'—Å–∫–ª–æ–Ω–Ω—ã –∫ —Å–∞–º–æ—É–≤–µ—Ä–µ–Ω–∏—é': '–ø—Ä–æ—è–≤–ª—è–µ—Ç–µ –∏–∑–±—ã—Ç–æ—á–Ω—É—é —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å',
            r'—á—É–≤—Å—Ç–≤—É–µ—Ç–µ, —á—Ç–æ': '—Å–∏—Å—Ç–µ–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ',
            r'–≤–∞–º –∫–∞–∂–µ—Ç—Å—è': '–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç',
            r'–≤—ã –ø–æ–Ω–∏–º–∞–µ—Ç–µ': '–¥–∞–Ω–Ω—ã–µ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—Ç',
            r'–≤—ã –æ—Å–æ–∑–Ω–∞–µ—Ç–µ': '–Ω–∞–±–ª—é–¥–∞–µ—Ç—Å—è',
            r'–∏–º–µ–µ—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å': '–º–æ–∂–µ—Ç–µ',
            r'—Å—Ç–æ–∏—Ç –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å': '–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å'
        }
        
        for error, correction in grammar_fixes.items():
            report = re.sub(error, correction, report, flags=re.IGNORECASE)
        
        # –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–æ–≤
        lines = report.split('\n')
        unique_lines = []
        seen_sections = set()
        
        for line in lines:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ä–∞–∑–¥–µ–ª–æ–≤
            line_stripped = line.strip()
            if re.match(r'^[‚¨õÔ∏èüìäüß†‚ö°Ô∏èüéØüõëüíªüîãüîëüöÄ]', line_stripped) or any(marker in line_stripped for marker in ['–£–ó–ï–õ', '–•–û–õ–û–°–¢–û–ô', '–†–ï–ê–ö–¢–û–†', '–ú–ï–¢–ê-–ú–ê–Ø–ö', '–í–ê–®–ê –ú–ï–¢–ê–§–û–†–ú–£–õ–ê']):
                section_key = re.sub(r'[^\w\s]', '', line_stripped).strip()[:30]
                if section_key in seen_sections:
                    continue
                seen_sections.add(section_key)
            
            unique_lines.append(line)
        
        report = '\n'.join(unique_lines)
        
        # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
        report = re.sub(r'\n{3,}', '\n\n', report)
        report = re.sub(r'[ \t]{2,}', ' ', report)
        
        # –£–±–∏—Ä–∞–µ–º markdown —Ä–∞–∑–º–µ—Ç–∫—É
        report = re.sub(r'[*_`]+', '', report)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
        required_sections = [
            '–£–†–û–í–ï–ù–¨ –°–ò–°–¢–ï–ú–ù–û–ì–û –ó–ê–°–¢–û–Ø',
            '–£–ó–ï–õ –°–û–ü–†–û–¢–ò–í–õ–ï–ù–ò–Ø',
            '–•–û–õ–û–°–¢–û–ô –•–û–î',
            '–†–ï–ê–ö–¢–û–† –ò–î–ï–ù–¢–ò–ß–ù–û–°–¢–ò',
            '–ú–ï–¢–ê-–ú–ê–Ø–ö',
            '–í–ê–®–ê –ú–ï–¢–ê–§–û–†–ú–£–õ–ê'
        ]
        
        for section in required_sections:
            if section not in report.upper():
                # –ï—Å–ª–∏ –∫–∞–∫–æ–≥–æ-—Ç–æ —Ä–∞–∑–¥–µ–ª–∞ –Ω–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–ª—É—à–∫—É
                if section == '–•–û–õ–û–°–¢–û–ô –•–û–î':
                    report = report.replace('–£–ó–ï–õ –°–û–ü–†–û–¢–ò–í–õ–ï–ù–ò–Ø', '–£–ó–ï–õ –°–û–ü–†–û–¢–ò–í–õ–ï–ù–ò–Ø\n\n–•–û–õ–û–°–¢–û–ô –•–û–î (–†–ï–ñ–ò–ú –ó–ê–°–¢–ê–í–ö–ò): –§–æ–Ω–æ–≤—ã–µ –º—ã—Å–ª–∏ —É—Ç–∏–ª–∏–∑–∏—Ä—É—é—Ç 80% —ç–Ω–µ—Ä–≥–∏–∏. –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Ö–æ–ª–æ—Å—Ç–æ–º —Ö–æ–¥—É.')
        
        return report
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ clean_report_for_telegram: {e}")
        return report

# --- –í–ï–ë-–°–ï–†–í–ï–† ---
async def handle_health(request):
    uptime = datetime.now() - start_time
    return web.Response(text=f"–ú–µ—Ç–∞-–ù–∞–≤–∏–≥–∞—Ç–æ—Ä v2 | –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: {str(uptime).split('.')[0]} | –û—à–∏–±–æ–∫: {error_counter} | –°–±–æ–µ–≤ API: {api_failures}")

async def send_startup_notification():
    try:
        bot_info = await bot.get_me()
        msg = (
            "üöÄ META-NAVIGATOR v2 –ó–ê–ü–£–©–ï–ù\n\n"
            f"‚è∞ –í—Ä–µ–º—è: {datetime.now().strftime('%d.%m %H:%M:%S')}\n"
            f"ü§ñ –ë–æ—Ç: @{bot_info.username}\n"
            f"üß† –†–µ–∂–∏–º: –°—Ç–∞—Ä—à–∏–π –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä (–ö–∏–±–µ—Ä-–º–∏—Å—Ç–∏—Ü–∏–∑–º)\n"
            f"üîë Cerebras API: {'‚úÖ' if CEREBRAS_API_KEY else '‚ùå –î–ï–ú–û-–†–ï–ñ–ò–ú'}\n"
            f"üìä –ü–æ—Ä—Ç–∞–ª: {os.environ.get('PORT', 8080)}\n"
            f"üìé PDF –¥–æ—Å—Ç–∞–≤–∫–∞: –ê–ö–¢–ò–í–ù–ê\n"
            f"üéØ MK —Å–¥–≤–∏–≥: 30 —Å–µ–∫ –∑–∞–¥–µ—Ä–∂–∫–∞\n"
            f"‚ö°Ô∏è –û—Ç—á–µ—Ç: –° –•–û–õ–û–°–¢–´–ú –•–û–î–û–ú"
        )
        await bot.send_message(chat_id=ADMIN_ID, text=msg)
    except Exception as e:
        logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ: {e}")

async def main():
    if not TOKEN:
        logger.error("‚ùå –û–®–ò–ë–ö–ê: BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
        raise ValueError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    
    if not CEREBRAS_API_KEY:
        logger.warning("‚ö†Ô∏è AI_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–µ–Ω! –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–µ–º–æ-—Ä–µ–∂–∏–º.")
    
    try:
        await bot.delete_webhook(drop_pending_updates=True)
    except Exception as e:
        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –≤–µ–±—Ö—É–∫: {e}")
    
    app = web.Application()
    app.router.add_get('/', handle_health)
    app.router.add_get('/health', handle_health)
    
    runner = web.AppRunner(app)
    await runner.setup()
    
    port = int(os.environ.get("PORT", 8080))
    site = web.TCPSite(runner, '0.0.0.0', port)
    await site.start()
    
    await send_startup_notification()
    
    logger.info(f"‚úÖ –ú–µ—Ç–∞-–ù–∞–≤–∏–≥–∞—Ç–æ—Ä v2 –∑–∞–ø—É—â–µ–Ω")
    logger.info(f"ü§ñ –ë–æ—Ç: @{(await bot.get_me()).username}")
    logger.info(f"üß† –†–µ–∂–∏–º: –°—Ç–∞—Ä—à–∏–π –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä")
    logger.info(f"üîë Cerebras API: {'‚úÖ' if CEREBRAS_API_KEY else '‚ùå –î–ï–ú–û-–†–ï–ñ–ò–ú'}")
    logger.info(f"üìé PDF –¥–æ—Å—Ç–∞–≤–∫–∞: –ê–ö–¢–ò–í–ù–ê")
    logger.info(f"üéØ MK —Å–¥–≤–∏–≥: 30 —Å–µ–∫ –∑–∞–¥–µ—Ä–∂–∫–∞")
    logger.info(f"‚ö°Ô∏è –û—Ç—á–µ—Ç: –í–ö–õ–Æ–ß–ï–ù –•–û–õ–û–°–¢–û–ô –•–û–î")
    logger.info(f"üåê –ü—Ä–æ–≤–µ—Ä–∫–∞: http://0.0.0.0:{port}/")
    logger.info(f"üìù –û–ø—Ä–æ—Å–Ω–∏–∫: {len(QUESTIONS)} –≤–æ–ø—Ä–æ—Å–æ–≤")
    
    try:
        await dp.start_polling(bot, skip_updates=True)
    except Exception as e:
        logger.critical(f"–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {e}")
        await send_admin_alert("bot_crash", f"–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {str(e)}", traceback.format_exc())
        raise

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        logger.critical(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ: {e}")
        exit(1)
