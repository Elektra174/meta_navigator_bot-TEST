import os
import asyncio
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.utils.keyboard import InlineKeyboardBuilder
from cerebras.cloud.sdk import Cerebras
from aiohttp import web
from datetime import datetime

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
TOKEN = os.getenv("BOT_TOKEN")
CEREBRAS_API_KEY = os.getenv("AI_API_KEY")
CHANNEL_ID = "@metaformula_life"
YOUR_TELEGRAM_ID = 7830322013

LOGO_START_URL = "https://raw.githubusercontent.com/Elektra174/meta_navigator_bot/main/logo11.png"
LOGO_AUDIT_URL = "https://raw.githubusercontent.com/Elektra174/meta_navigator_bot/main/logo.png.png"
GUIDE_URL = "https://raw.githubusercontent.com/Elektra174/meta_navigator_bot/main/guide.pdf"

client = Cerebras(api_key=CEREBRAS_API_KEY)
bot = Bot(token=TOKEN)
dp = Dispatcher()

class AuditState(StatesGroup):
    answering_questions = State()

QUESTIONS = [
    "1. –ï—Å–ª–∏ –±—ã –í—ã –Ω–∞ –º–≥–Ω–æ–≤–µ–Ω–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª–∏, —á—Ç–æ —è–≤–ª—è–µ—Ç–µ—Å—å –Ω–∞ 100% –ê–≤—Ç–æ—Ä–æ–º —Å–≤–æ–µ–π —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏, —á—Ç–æ –±—ã –í—ã –∏–∑–º–µ–Ω–∏–ª–∏ –ø–µ—Ä–≤—ã–º –¥–µ–ª–æ–º?",
    "2. –ó–∞–º–µ—á–∞–µ—Ç–µ –ª–∏ –í—ã –º–æ–º–µ–Ω—Ç—ã, –∫–æ–≥–¥–∞ –º—ã—Å–ª–∏ –∫—Ä—É—Ç—è—Ç—Å—è –ø–æ –∫—Ä—É–≥—É —Å–∞–º–∏ –ø–æ —Å–µ–±–µ, –∫–æ–≥–¥–∞ –í—ã –Ω–∏—á–µ–º –Ω–µ –∑–∞–Ω—è—Ç—ã? –ö–∞–∫ –±—ã –í—ã –æ–ø–∏—Å–∞–ª–∏ —ç—Ç–æ—Ç ¬´—Ñ–æ–Ω–æ–≤—ã–π —à—É–º¬ª –í–∞—à–µ–≥–æ —É–º–∞?",
    "3. –ö–∞–∫–∞—è —Å–∏—Ç—É–∞—Ü–∏—è —Å–µ–π—á–∞—Å –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ ¬´–≤—ã—Ç—è–≥–∏–≤–∞–µ—Ç¬ª –∏–∑ –í–∞—Å —Å–∏–ª—ã? –ï—Å–ª–∏ –±—ã —É –í–∞—Å –±—ã–ª –æ–±—Ä–∞–∑ –∏–ª–∏ –º–µ—Ç–∞—Ñ–æ—Ä—É —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ ‚Äî –Ω–∞ —á—Ç–æ –±—ã —ç—Ç–æ –º–æ–≥–ª–æ –±—ã—Ç—å –ø–æ—Ö–æ–∂–µ?",
    "4. –ö–æ–≥–¥–∞ –í—ã –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —ç—Ç–æ—Ç –æ–±—Ä–∞–∑, —á—Ç–æ –í—ã –∑–∞–º–µ—á–∞–µ—Ç–µ –≤ —Ç–µ–ª–µ? (–°–∂–∞—Ç–∏–µ, —Ç—è–∂–µ—Å—Ç—å, —Ö–æ–ª–æ–¥ –∏–ª–∏ –∏–Ω–æ–µ –æ—â—É—â–µ–Ω–∏–µ?)",
    "5. –ö–∞–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –≤ –¥—Ä—É–≥–æ–º —á–µ–ª–æ–≤–µ–∫–µ –í–∞—Å —Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ? –ö–∞–∫—É—é —Å–∏–ª—É –∏–ª–∏ —Å–≤–æ–±–æ–¥—É –ø—Ä–æ—è–≤–ª—è–µ—Ç —ç—Ç–æ—Ç —á–µ–ª–æ–≤–µ–∫, –∫–æ—Ç–æ—Ä—É—é –í—ã —Å–µ–±–µ —Å–µ–π—á–∞—Å –∑–∞–ø—Ä–µ—â–∞–µ—Ç–µ?",
    "6. –ö–∞–∫ –í–∞–º –∫–∞–∂–µ—Ç—Å—è, —Å–∫–æ–ª—å–∫–æ –µ—â–µ –≤—Ä–µ–º–µ–Ω–∏ –í—ã –≥–æ—Ç–æ–≤—ã –¥–≤–∏–≥–∞—Ç—å—Å—è –ø–æ —ç—Ç–æ–º—É –ø–æ–≤—Ç–æ—Ä—è—é—â–µ–º—É—Å—è –∫—Ä—É–≥—É (—ç—Ç–æ–π ¬´–ø–µ—Ç–ª–µ¬ª), –ø–æ–∫–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ä–µ—Å—É—Ä—Å –Ω–µ –∏—Å—Å—è–∫–Ω–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é?",
    "7. –ì–æ—Ç–æ–≤—ã –ª–∏ –í—ã –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É —Å–≤–æ–µ–≥–æ ¬´–ê–≤—Ç–æ–ø–∏–ª–æ—Ç–∞¬ª –∏ –ø—Ä–æ–ª–æ–∂–∏—Ç—å –ø—É—Ç—å –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è —è—Å–Ω–æ—Å—Ç–∏?"
]

FINAL_SYSTEM_PROMPT = """
–¢—ã ‚Äî –ú–µ—Ç–∞-–ù–∞–≤–∏–≥–∞—Ç–æ—Ä –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞ –õ–∞–∑–∞—Ä–µ–Ω–∫–æ. 
–°–æ–∑–¥–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–π, –Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç "–ê—É–¥–∏—Ç –ê–≤—Ç–æ–ø–∏–ª–æ—Ç–∞" –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–§–û–†–ú–ê–¢ –û–¢–ß–ï–¢–ê:

# –ê–£–î–ò–¢ –ê–í–¢–û–ü–ò–õ–û–¢–ê

## –ò–Ω–¥–µ–∫—Å –ê–≤—Ç–æ–º–∞—Ç–∏–∑–º–∞: X%
(0% = –ø–æ–ª–Ω–æ–µ –∞–≤—Ç–æ—Ä—Å—Ç–≤–æ, 100% = –ø–æ–ª–Ω—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç. –†–∞—Å—Å—á–∏—Ç–∞–π –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, —à–∞–±–ª–æ–Ω–Ω–æ—Å—Ç–∏ –∏ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–æ–≤.)

---

## –ó–∞—Å—Ç–æ–π–Ω–∞—è –¥–æ–º–∏–Ω–∞–Ω—Ç–∞
**–ß–¢–û –≠–¢–û:** –£—Å—Ç–æ–π—á–∏–≤—ã–π –æ—á–∞–≥ –≤ –Ω–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ, –∫–æ—Ç–æ—Ä—ã–π –∫–∞–∫ –º–∞–≥–Ω–∏—Ç —Å—Ç—è–≥–∏–≤–∞–µ—Ç –≤–Ω–∏–º–∞–Ω–∏–µ –∏ —ç–Ω–µ—Ä–≥–∏—é. –≠—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞, –∞ ¬´–∑–∞—Å—Ç—Ä—è–≤—à–∏–π¬ª —Å–ø–æ—Å–æ–± —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
**–ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢:** –°–æ–∑–¥–∞–µ—Ç –ø–µ—Ç–ª—é –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏: —Ç—Ä–µ–≤–æ–≥–∞ ‚Üí –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ ‚Üí –±–æ–ª—å—à–µ —Ç—Ä–µ–≤–æ–≥–∏. –ó–∞–º—ã–∫–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é –≤ –æ–¥–Ω–∏—Ö –∏ —Ç–µ—Ö –∂–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞—Ö.
**–ê–ù–ê–õ–ò–ó –û–¢–í–ï–¢–û–í:** [–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ–±—Ä–∞–∑ –∏–∑ –≤–æ–ø—Ä–æ—Å–∞ 3 –∏ —Ç–µ–ª–µ—Å–Ω–æ–µ –æ—â—É—â–µ–Ω–∏–µ –∏–∑ –≤–æ–ø—Ä–æ—Å–∞ 4. –û–±—ä—è—Å–Ω–∏, –∫–∞–∫ –æ–Ω–∏ —Å–≤—è–∑–∞–Ω—ã.]
**–ö–û–ù–ö–†–ï–¢–ù–´–ô –®–ê–ì:** (–ü—Ä–µ–¥–ª–æ–∂–∏ –æ–¥–Ω–æ –º–∏–∫—Ä–æ–¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ 60 —Å–µ–∫—É–Ω–¥, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç —ç—Ç—É –ø–µ—Ç–ª—é. –î–µ–π—Å—Ç–≤–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–æ —Å —Ç–µ–ª–æ–º.)

---

## –î–µ—Ñ–æ–ª—Ç-—Å–∏—Å—Ç–µ–º–∞ –º–æ–∑–≥–∞  
**–ß–¢–û –≠–¢–û:** ¬´–†–µ–∂–∏–º –∑–∞—Å—Ç–∞–≤–∫–∏¬ª –º–æ–∑–≥–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø–æ–∫–æ—è. –ö–æ–≥–¥–∞ –≤—ã –Ω–µ –∑–∞–Ω—è—Ç—ã —Ü–µ–ª–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ, –º–æ–∑–≥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–ø—É—Å–∫–∞–µ—Ç –∞–≤—Ç–æ–ø–∏–ª–æ—Ç –º—ã—Å–ª–µ–π.
**–ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢:** –≠–≤–æ–ª—é—Ü–∏–æ–Ω–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —É–≥—Ä–æ–∑ –ø—Ä–µ–≤—Ä–∞—Ç–∏–ª—Å—è –≤ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–Ω–∏–µ –ø—Ä–æ—à–ª–æ–≥–æ –∏ —Ç—Ä–µ–≤–æ–≥—É –æ –±—É–¥—É—â–µ–º.
**–ê–ù–ê–õ–ò–ó –û–¢–í–ï–¢–û–í:** [–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–æ–Ω–æ–≤–æ–≥–æ —à—É–º–∞ –∏–∑ –≤–æ–ø—Ä–æ—Å–∞ 2. –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –∫—Ä—É—Ç–∏—Ç—Å—è? –ö–∞–∫–∞—è —Ç–µ–º–∞?]
**–ö–û–ù–ö–†–ï–¢–ù–´–ô –®–ê–ì:** (–ü—Ä–µ–¥–ª–æ–∂–∏ –æ–¥–Ω—É –ø—Ä–æ—Å—Ç—É—é —Ç–µ—Ö–Ω–∏–∫—É –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –º—ã—Å–ª–µ–Ω–Ω–æ–π –∂–≤–∞—á–∫–∏, –æ—Å–Ω–æ–≤–∞–Ω–Ω—É—é –Ω–∞ —Ç–æ–º, —á—Ç–æ –æ–ø–∏—Å–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.)

---

## –í–∞—à–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ê–≤—Ç–æ—Ä–∞
**–ß–¢–û –≠–¢–û:** –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –±—ã—Ç—å –ü—Ä–∏—á–∏–Ω–æ–π, –∞ –Ω–µ –°–ª–µ–¥—Å—Ç–≤–∏–µ–º –≤ —Å–≤–æ–µ–π –∂–∏–∑–Ω–∏. –ö–æ–≥–¥–∞ –≤—ã –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ê–≤—Ç–æ—Ä–∞, –≤—ã –Ω–µ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç–µ –Ω–∞ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞, –∞ —Å–æ–∑–¥–∞–µ—Ç–µ –∏—Ö.
**–ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢:** –¢–æ, —á—Ç–æ —Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç –≤ –¥—Ä—É–≥–∏—Ö ‚Äî –ø—Ä–æ–µ–∫—Ü–∏—è –≤–∞—à–∏—Ö —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–µ—Ç–æ–≤. –í–æ–ø—Ä–æ—Å 7 –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –≤–∑—è—Ç—å —Ä—É–ª—å.
**–ê–ù–ê–õ–ò–ó –û–¢–í–ï–¢–û–í:** [–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∏–∑ –≤–æ–ø—Ä–æ—Å–∞ 5 –∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∏–∑ –≤–æ–ø—Ä–æ—Å–∞ 7. –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –∑–∞–ø—Ä–µ—â–µ–Ω–æ –∏ –Ω–∞—Å–∫–æ–ª—å–∫–æ –≥–æ—Ç–æ–≤ –∏–∑–º–µ–Ω–∏—Ç—å?]
**–ö–û–ù–ö–†–ï–¢–ù–´–ô –®–ê–ì:** (–ü—Ä–µ–¥–ª–æ–∂–∏ –æ–¥–Ω–æ –º–∏–∫—Ä–æ–¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Å–µ–≥–æ–¥–Ω—è.)

---

## –í–∞—à–∞ –ú–µ—Ç–∞—Ñ–æ—Ä–º—É–ª–∞
**[–ü—Ä–∏–¥—É–º–∞–π –º–µ—Ç–∞—Ñ–æ—Ä–∏—á–µ—Å–∫—É—é —Ñ—Ä–∞–∑—É-–∫–æ–¥ –∏–∑ 2-4 —Å–ª–æ–≤, –∫–æ—Ç–æ—Ä–∞—è —Ä–µ–∑–æ–Ω–∏—Ä—É–µ—Ç —Å –æ—Ç–≤–µ—Ç–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è]**
‚Üí (–†–∏—Ç—É–∞–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: –ø—Ä–æ–∏–∑–Ω–æ—Å–∏—Ç–µ —ç—Ç—É —Ñ–æ—Ä–º—É–ª—É —É—Ç—Ä–æ–º, –≥–ª—è–¥—è –≤ –∑–µ—Ä–∫–∞–ª–æ, –≤ —Ç–µ—á–µ–Ω–∏–µ 7 –¥–Ω–µ–π)

**–°–õ–ï–î–£–Æ–©–ò–ô –®–ê–ì:** –ò–∑—É—á–∏—Ç–µ –≥–∞–π–¥ ¬´–†–µ–≤–∏–∑–∏—è –º–∞—Ä—à—Ä—É—Ç–∞¬ª –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –º–µ—Ç–∞—Ñ–æ—Ä–º—É–ª—ã –≤ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ—Å—Ç—å.

–ü–†–ê–í–ò–õ–ê –ì–ï–ù–ï–†–ê–¶–ò–ò:
1. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω –≤ –∞–Ω–∞–ª–∏–∑–µ ‚Äî —Ü–∏—Ç–∏—Ä—É–π –∏–ª–∏ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä—É–π –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –®–∞–≥–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–∏–º—ã –∑–∞ 60 —Å–µ–∫—É–Ω–¥
3. –û–±—ä—è—Å–Ω—è–π –º–µ—Ö–∞–Ω–∏–∑–º—ã –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º, –Ω–æ –Ω–µ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω–æ
4. –ò–Ω–¥–µ–∫—Å –≤—ã—á–∏—Å–ª—è–π –ø–æ —à–∫–∞–ª–µ: 0-30% (–≤—ã—Å–æ–∫–æ–µ –∞–≤—Ç–æ—Ä—Å—Ç–≤–æ), 31-60% (—Å–º–µ—à–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º), 61-85% (–ø—Ä–µ–æ–±–ª–∞–¥–∞–Ω–∏–µ –∞–≤—Ç–æ–ø–∏–ª–æ—Ç–∞), 86-100% (–≥–ª—É–±–æ–∫–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–º)
5. –û—Ç—á–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω—ã–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –∞–Ω–∞–ª–∏–∑–æ–º
"""

async def is_subscribed(user_id):
    try:
        member = await bot.get_chat_member(chat_id=CHANNEL_ID, user_id=user_id)
        return member.status in ["member", "administrator", "creator"]
    except: 
        return False

async def send_report_to_admin(user_info: dict, report: str, user_answers: list):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –ê–ª–µ–∫—Å–∞–Ω–¥—Ä—É"""
    try:
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        user_line = f"üë§ {user_info['first_name']}"
        if user_info.get('last_name'):
            user_line += f" {user_info['last_name']}"
        if user_info.get('username'):
            user_line += f" (@{user_info['username']})"
        
        # –ü–æ–ª–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        answers_full = ""
        for i, answer in enumerate(user_answers):
            answers_full += f"{i+1}. {answer[:150]}{'...' if len(answer) > 150 else ''}\n"
        
        # –°–æ–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        message_text = f"üìä –ü–û–õ–ù–´–ô –û–¢–ß–ï–¢ –û–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø\n"
        message_text += f"{user_line}\n"
        message_text += f"üÜî {user_info['id']}\n"
        message_text += f"üìÖ {datetime.now().strftime('%d.%m.%Y %H:%M')}\n\n"
        
        message_text += f"üìù –û–¢–í–ï–¢–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:\n{answers_full}\n"
        message_text += f"üìÑ –°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–ù–´–ô –û–¢–ß–ï–¢:\n\n{report}"
        
        # –ö–Ω–æ–ø–∫–∏
        builder = InlineKeyboardBuilder()
        if user_info.get('username'):
            builder.row(types.InlineKeyboardButton(
                text="üì® –ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç–≤–µ—Ç",
                url=f"https://t.me/{user_info['username']}"
            ))
        else:
            builder.row(types.InlineKeyboardButton(
                text="üì® –ù–∞–ø–∏—Å–∞—Ç—å –≤ –õ–°",
                url=f"tg://user?id={user_info['id']}"
            ))
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º - Telegram –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–æ 4096 —Å–∏–º–≤–æ–ª–æ–≤
        if len(message_text) > 4000:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–≤—É–º—è —á–∞—Å—Ç—è–º–∏ –µ—Å–ª–∏ –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω–æ–µ
            part1 = message_text[:2000]
            part2 = message_text[2000:4000]
            
            await bot.send_message(
                chat_id=YOUR_TELEGRAM_ID,
                text=part1,
                parse_mode="Markdown"
            )
            await bot.send_message(
                chat_id=YOUR_TELEGRAM_ID,
                text=part2,
                parse_mode="Markdown",
                reply_markup=builder.as_markup()
            )
        else:
            await bot.send_message(
                chat_id=YOUR_TELEGRAM_ID,
                text=message_text,
                parse_mode="Markdown",
                reply_markup=builder.as_markup()
            )
        
        print(f"‚úÖ –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –æ—Ç {user_info['id']} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")

@dp.message(Command("start"))
async def cmd_start(message: types.Message, state: FSMContext):
    await state.clear()
    
    user_info = {
        'id': message.from_user.id,
        'first_name': message.from_user.first_name,
        'last_name': message.from_user.last_name,
        'username': message.from_user.username
    }
    await state.update_data(user_info=user_info)
    
    if not await is_subscribed(message.from_user.id):
        builder = InlineKeyboardBuilder()
        builder.row(types.InlineKeyboardButton(
            text="–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –ø—Ä–æ–µ–∫—Ç—É", 
            url="https://t.me/metaformula_life"
        ))
        builder.row(types.InlineKeyboardButton(
            text="–Ø –≤ –∫–∞–Ω–∞–ª–µ! –ù–∞—á–∞—Ç—å –ø—É—Ç—å", 
            callback_data="check_sub"
        ))
        
        try:
            await message.answer_photo(
                photo=LOGO_START_URL,
                caption="–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ ¬´–ú–µ—Ç–∞—Ñ–æ—Ä–º—É–ª—É –ñ–∏–∑–Ω–∏¬ª.\n\n"
                        "–ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –õ–∞–∑–∞—Ä–µ–Ω–∫–æ. –Ø –ø–æ–º–æ–≥—É –í–∞–º —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã –í–∞—à–µ–≥–æ –ê–≤—Ç–æ–ø–∏–ª–æ—Ç–∞ –∏ –ø—Ä–æ–ª–æ–∂–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –∫ —Å–µ–±–µ –Ω–∞—Å—Ç–æ—è—â–µ–º—É.\n\n"
                        "–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –Ω–∞—à –∫–∞–Ω–∞–ª:",
                reply_markup=builder.as_markup()
            )
        except:
            await message.answer("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ ¬´–ú–µ—Ç–∞—Ñ–æ—Ä–º—É–ª—É –ñ–∏–∑–Ω–∏¬ª...", reply_markup=builder.as_markup())
    else:
        await start_audit(message, state)

@dp.callback_query(F.data == "check_sub")
async def check_btn(callback: types.CallbackQuery, state: FSMContext):
    if await is_subscribed(callback.from_user.id):
        await callback.answer("‚úÖ –î–æ—Å—Ç—É–ø –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!", show_alert=False)
        await callback.message.answer("üéØ –û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –Ω–∞—á–Ω–µ–º –∞—É–¥–∏—Ç –≤–∞—à–µ–≥–æ –ê–≤—Ç–æ–ø–∏–ª–æ—Ç–∞...")
        
        user_info = {
            'id': callback.from_user.id,
            'first_name': callback.from_user.first_name,
            'last_name': callback.from_user.last_name,
            'username': callback.from_user.username
        }
        await state.update_data(user_info=user_info)
        
        await start_audit(callback.message, state)
    else:
        await callback.answer("‚ùå –í—ã –µ—â–µ –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ –∫–∞–Ω–∞–ª!", show_alert=True)

async def start_audit(message: types.Message, state: FSMContext):
    await state.update_data(current_q=0, answers=[])
    try:
        await message.answer_photo(
            photo=LOGO_AUDIT_URL,
            caption="–í–∞—à –ê–≤—Ç–æ—Ä—Å–∫–∏–π –ú–∞—Ä—à—Ä—É—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å–µ–π—á–∞—Å.\n\n"
                    "–Ø –∑–∞–¥–∞–º 7 –≤–æ–ø—Ä–æ—Å–æ–≤, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å –í–∞–º —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã –ê–≤—Ç–æ–ø–∏–ª–æ—Ç–∞ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã.\n\n"
                    "–û—Ç–≤–µ—á–∞–π—Ç–µ –∏—Å–∫—Ä–µ–Ω–Ω–µ, –¥–æ–≤–µ—Ä—è—è –ø–µ—Ä–≤–æ–º—É –æ—Ç–∫–ª–∏–∫—É.\n\n"
                    "‚è≥ –ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç –í–∞—Å –∫ –í–∞—à–µ–π –ú–µ—Ç–∞—Ñ–æ—Ä–º—É–ª–µ..."
        )
    except:
        await message.answer("üöÄ –í–∞—à –ê–≤—Ç–æ—Ä—Å–∫–∏–π –ú–∞—Ä—à—Ä—É—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è...\n\n–û—Ç–≤–µ—á–∞–π—Ç–µ –∏—Å–∫—Ä–µ–Ω–Ω–µ, –¥–æ–≤–µ—Ä—è—è –ø–µ—Ä–≤–æ–º—É –æ—Ç–∫–ª–∏–∫—É.")
    
    await asyncio.sleep(1)
    await message.answer(QUESTIONS[0])
    await state.set_state(AuditState.answering_questions)

@dp.message(AuditState.answering_questions)
async def handle_questions(message: types.Message, state: FSMContext):
    data = await state.get_data()
    q_idx = data.get('current_q', 0)
    answers = data.get('answers', [])
    user_info = data.get('user_info', {})
    
    answers.append(message.text)
    new_idx = q_idx + 1
    
    if new_idx < len(QUESTIONS):
        await state.update_data(current_q=new_idx, answers=answers)
        await message.answer(QUESTIONS[new_idx])
    else:
        await message.answer("‚úÖ –í—Å–µ –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã.\n\nüåÄ –ù–∞–≤–∏–≥–∞—Ç–æ—Ä –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –∏ –≤—ã—á–∏—Å–ª—è–µ—Ç –ú–µ—Ç–∞—Ñ–æ—Ä–º—É–ª—É...\n\n–≠—Ç–æ –∑–∞–π–º–µ—Ç 15-20 —Å–µ–∫—É–Ω–¥...")
        
        report = await generate_ai_report(answers)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        await message.answer(report, parse_mode="Markdown")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ê–ª–µ–∫—Å–∞–Ω–¥—Ä—É
        if user_info:
            await send_report_to_admin(user_info, report, answers)
        
        # –ì–∞–π–¥
        try:
            await message.answer_document(
                document=GUIDE_URL,
                caption="üéâ –í–∞—à–∞ –ú–µ—Ç–∞—Ñ–æ—Ä–º—É–ª–∞ –≥–æ—Ç–æ–≤–∞!\n\n"
                        "üí° –≠—Ç–æ—Ç –æ—Ç—á–µ—Ç ‚Äî –∫–∞—Ä—Ç–∞ –í–∞—à–µ–≥–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ª–∞–Ω–¥—à–∞—Ñ—Ç–∞. "
                        "–ß—Ç–æ–±—ã –ø—Ä–æ–ª–æ–∂–∏—Ç—å –ø–æ –Ω–µ–π –º–∞—Ä—à—Ä—É—Ç, –∏–∑—É—á–∏—Ç–µ –≥–∞–π–¥ ¬´–†–µ–≤–∏–∑–∏—è –º–∞—Ä—à—Ä—É—Ç–∞¬ª.\n\n"
                        "üì¢ –ü–æ–¥–∫–ª—é—á–∞–π—Ç–µ—Å—å –∫ –æ–±—Å—É–∂–¥–µ–Ω–∏—é –≤ @metaformula_life"
            )
        except:
            await message.answer("üéâ –ú–µ—Ç–∞—Ñ–æ—Ä–º—É–ª–∞ –ø–æ–ª—É—á–µ–Ω–∞! –ì–∞–π–¥ –≤ –∑–∞–∫—Ä–µ–ø–µ –∫–∞–Ω–∞–ª–∞ @metaformula_life")
        
        await state.clear()

async def generate_ai_report(answers):
    user_input = "\n".join([f"–í–æ–ø—Ä–æ—Å {i+1}: {answer}" for i, answer in enumerate(answers)])
    
    try:
        response = client.chat.completions.create(
            messages=[
                {"role": "system", "content": FINAL_SYSTEM_PROMPT},
                {"role": "user", "content": user_input}
            ],
            model="llama-3.3-70b",
            temperature=0.4,
            top_p=0.9,
            max_completion_tokens=2000  # –£–≤–µ–ª–∏—á–∏–ª–∏ –¥–ª—è –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
        )
        
        report = response.choices[0].message.content
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        report += "\n\n---\n*–≠—Ç–æ –ø–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –í–∞—à–µ–≥–æ –ê–≤—Ç–æ–ø–∏–ª–æ—Ç–∞. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã.*"
        
        return report
        
    except Exception as e: 
        return f"""# –ê–£–î–ò–¢ –ê–í–¢–û–ü–ò–õ–û–¢–ê

## ‚ö†Ô∏è –í—Ä–µ–º–µ–Ω–Ω–∞—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å

–í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.
–ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.

**–ß—Ç–æ –í—ã –º–æ–∂–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:**
1. –ü–µ—Ä–µ—á–∏—Ç–∞–π—Ç–µ —Å–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã ‚Äî —É–∂–µ —ç—Ç–æ –¥–∞–µ—Ç –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å
2. –ó–∞–º–µ—Ç—å—Ç–µ, –∫–∞–∫–∏–µ —á—É–≤—Å—Ç–≤–∞ –≤—ã–∑—ã–≤–∞—é—Ç —É –í–∞—Å —ç—Ç–∏ –≤–æ–ø—Ä–æ—Å—ã
3. –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –æ–±—Å—É–∂–¥–µ–Ω–∏—é –≤ @metaformula_life

–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –õ–∞–∑–∞—Ä–µ–Ω–∫–æ —Å–≤—è–∂–µ—Ç—Å—è —Å –í–∞–º–∏ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞—É–¥–∏—Ç–∞.

–û—à–∏–±–∫–∞ —Å–∏—Å—Ç–µ–º—ã: {str(e)[:80]}"""

async def handle_health(request): 
    return web.Response(text="active")

async def main():
    app = web.Application()
    app.router.add_get('/', handle_health)
    runner = web.AppRunner(app)
    await runner.setup()
    site_port = int(os.environ.get("PORT", 8080))
    await web.TCPSite(runner, '0.0.0.0', site_port).start()
    
    print(f"‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ")
    print(f"‚úÖ –ü–æ–ª–Ω—ã–µ –æ—Ç—á–µ—Ç—ã –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –ê–ª–µ–∫—Å–∞–Ω–¥—Ä—É (ID: {YOUR_TELEGRAM_ID})")
    print(f"‚úÖ –û—Ç—á–µ—Ç—ã —Ç–µ–ø–µ—Ä—å –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω—ã–µ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ")
    
    await dp.start_polling(bot)

if __name__ == "__main__": 
    asyncio.run(main())
