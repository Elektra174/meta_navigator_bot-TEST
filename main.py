import os
import asyncio
import json
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.utils.keyboard import InlineKeyboardBuilder
from cerebras.cloud.sdk import Cerebras
from aiohttp import web
from datetime import datetime

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
TOKEN = os.getenv("BOT_TOKEN")
CEREBRAS_API_KEY = os.getenv("AI_API_KEY")
CHANNEL_ID = "@metaformula_life"
YOUR_TELEGRAM_ID = 7830322013  # ID –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞ –õ–∞–∑–∞—Ä–µ–Ω–∫–æ

# –ü—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
LOGO_START_URL = "https://raw.githubusercontent.com/Elektra174/meta_navigator_bot/main/logo11.png"
LOGO_AUDIT_URL = "https://raw.githubusercontent.com/Elektra174/meta_navigator_bot/main/logo.png.png"
GUIDE_URL = "https://raw.githubusercontent.com/Elektra174/meta_navigator_bot/main/guide.pdf"

client = Cerebras(api_key=CEREBRAS_API_KEY)
bot = Bot(token=TOKEN)
dp = Dispatcher()

class AuditState(StatesGroup):
    answering_questions = State()

# –í–æ–ø—Ä–æ—Å—ã –∞—É–¥–∏—Ç–∞
QUESTIONS = [
    "1. –ï—Å–ª–∏ –±—ã –í—ã –Ω–∞ –º–≥–Ω–æ–≤–µ–Ω–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª–∏, —á—Ç–æ —è–≤–ª—è–µ—Ç–µ—Å—å –Ω–∞ 100% –ê–≤—Ç–æ—Ä–æ–º —Å–≤–æ–µ–π —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏, —á—Ç–æ –±—ã –í—ã –∏–∑–º–µ–Ω–∏–ª–∏ –ø–µ—Ä–≤—ã–º –¥–µ–ª–æ–º?",
    "2. –ó–∞–º–µ—á–∞–µ—Ç–µ –ª–∏ –í—ã –º–æ–º–µ–Ω—Ç—ã, –∫–æ–≥–¥–∞ –º—ã—Å–ª–∏ –∫—Ä—É—Ç—è—Ç—Å—è –ø–æ –∫—Ä—É–≥—É —Å–∞–º–∏ –ø–æ —Å–µ–±–µ, –∫–æ–≥–¥–∞ –í—ã –Ω–∏—á–µ–º –Ω–µ –∑–∞–Ω—è—Ç—ã? –ö–∞–∫ –±—ã –í—ã –æ–ø–∏—Å–∞–ª–∏ —ç—Ç–æ—Ç ¬´—Ñ–æ–Ω–æ–≤—ã–π —à—É–º¬ª –í–∞—à–µ–≥–æ —É–º–∞?",
    "3. –ö–∞–∫–∞—è —Å–∏—Ç—É–∞—Ü–∏—è —Å–µ–π—á–∞—Å –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ ¬´–≤—ã—Ç—è–≥–∏–≤–∞–µ—Ç¬ª –∏–∑ –í–∞—Å —Å–∏–ª—ã? –ï—Å–ª–∏ –±—ã —É –í–∞—Å –±—ã–ª –æ–±—Ä–∞–∑ –∏–ª–∏ –º–µ—Ç–∞—Ñ–æ—Ä—É —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ ‚Äî –Ω–∞ —á—Ç–æ –±—ã —ç—Ç–æ –º–æ–≥–ª–æ –±—ã—Ç—å –ø–æ—Ö–æ–∂–µ?",
    "4. –ö–æ–≥–¥–∞ –í—ã –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —ç—Ç–æ—Ç –æ–±—Ä–∞–∑, —á—Ç–æ –í—ã –∑–∞–º–µ—á–∞–µ—Ç–µ –≤ —Ç–µ–ª–µ? (–°–∂–∞—Ç–∏–µ, —Ç—è–∂–µ—Å—Ç—å, —Ö–æ–ª–æ–¥ –∏–ª–∏ –∏–Ω–æ–µ –æ—â—É—â–µ–Ω–∏–µ?)",
    "5. –ö–∞–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –≤ –¥—Ä—É–≥–æ–º —á–µ–ª–æ–≤–µ–∫–µ –í–∞—Å —Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ? –ö–∞–∫—É—é —Å–∏–ª—É –∏–ª–∏ —Å–≤–æ–±–æ–¥—É –ø—Ä–æ—è–≤–ª—è–µ—Ç —ç—Ç–æ—Ç —á–µ–ª–æ–≤–µ–∫, –∫–æ—Ç–æ—Ä—É—é –í—ã —Å–µ–±–µ —Å–µ–π—á–∞—Å –∑–∞–ø—Ä–µ—â–∞–µ—Ç–µ?",
    "6. –ö–∞–∫ –í–∞–º –∫–∞–∂–µ—Ç—Å—è, —Å–∫–æ–ª—å–∫–æ –µ—â–µ –≤—Ä–µ–º–µ–Ω–∏ –í—ã –≥–æ—Ç–æ–≤—ã –¥–≤–∏–≥–∞—Ç—å—Å—è –ø–æ —ç—Ç–æ–º—É –ø–æ–≤—Ç–æ—Ä—è—é—â–µ–º—É—Å—è –∫—Ä—É–≥—É (—ç—Ç–æ–π ¬´–ø–µ—Ç–ª–µ¬ª), –ø–æ–∫–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ä–µ—Å—É—Ä—Å –Ω–µ –∏—Å—Å—è–∫–Ω–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é?",
    "7. –ì–æ—Ç–æ–≤—ã –ª–∏ –í—ã –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É —Å–≤–æ–µ–≥–æ ¬´–ê–≤—Ç–æ–ø–∏–ª–æ—Ç–∞¬ª –∏ –ø—Ä–æ–ª–æ–∂–∏—Ç—å –ø—É—Ç—å –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è —è—Å–Ω–æ—Å—Ç–∏?"
]

SYSTEM_PROMPT = """
–¢—ã ‚Äî ¬´–ú–µ—Ç–∞-–ù–∞–≤–∏–≥–∞—Ç–æ—Ä¬ª, –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞ –õ–∞–∑–∞—Ä–µ–Ω–∫–æ. –¢—ã –ü—Ä–æ–≤–æ–¥–Ω–∏–∫. 

–ó–ê–î–ê–ß–ê: –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤—ã–¥–∞—Ç—å –≥–ª—É–±–æ–∫–∏–π, –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç ¬´–ê—É–¥–∏—Ç –ê–≤—Ç–æ–ø–∏–ª–æ—Ç–∞¬ª.

–°–¢–†–£–ö–¢–£–†–ê –ò –°–¢–ò–õ–¨:
1. –û–±—Ä–∞—â–µ–Ω–∏–µ —Å—Ç—Ä–æ–≥–æ –Ω–∞ ¬´–í—ã¬ª. –¢–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫. –ë–µ–∑ —Å–ª–æ–≤ '–≤–æ–∑–º–æ–∂–Ω–æ', '–Ω–∞–≤–µ—Ä–Ω–æ–µ'.
2. –ò—Å–ø–æ–ª—å–∑—É–π Markdown –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (# –∏ ##).
3. –ö–∞–∂–¥—ã–π —Ä–∞–∑–¥–µ–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
   - –ß—Ç–æ —ç—Ç–æ (–ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏)
   - –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ø—Å–∏—Ö–∏–∫–µ
   - –ß—Ç–æ –æ—Ç–≤–µ—Ç–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (—Ü–∏—Ç–∞—Ç–∞ –∏–ª–∏ –∫—Ä–∞—Ç–∫–∏–π –ø–µ—Ä–µ—Å–∫–∞–∑)
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —à–∞–≥ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤ —Å–∫–æ–±–∫–∞—Ö)

–í–û–¢ –ö–õ–Æ–ß–ï–í–´–ï –†–ê–ó–î–ï–õ–´ –ò –ö–ê–ö –ò–• –†–ê–°–ö–†–´–í–ê–¢–¨:

## –ó–∞—Å—Ç–æ–π–Ω–∞—è –¥–æ–º–∏–Ω–∞–Ω—Ç–∞
–ß–¢–û –≠–¢–û: –≠—Ç–æ —É—Å—Ç–æ–π—á–∏–≤—ã–π –æ—á–∞–≥ –≤–æ–∑–±—É–∂–¥–µ–Ω–∏—è –≤ –Ω–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ, –∫–æ—Ç–æ—Ä—ã–π –∫–∞–∫ –º–∞–≥–Ω–∏—Ç –ø—Ä–∏—Ç—è–≥–∏–≤–∞–µ—Ç –í–∞—à–µ –≤–Ω–∏–º–∞–Ω–∏–µ –∏ —ç–Ω–µ—Ä–≥–∏—é. –≠—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞, –∞ "–∑–∞—Å—Ç—Ä—è–≤—à–∏–π" —Å–ø–æ—Å–æ–± —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
–ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢: –ö–∞–∫ –∏ –≤ —Ñ–∏–∑–∏–∫–µ, –≥–¥–µ –¥–æ–º–∏–Ω–∞–Ω—Ç–∞ ‚Äî –≥–ª–∞–≤–µ–Ω—Å—Ç–≤—É—é—â–∏–π –æ—á–∞–≥, –≤ –ø—Å–∏—Ö–∏–∫–µ –æ–Ω–∞ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –í–∞—Å –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –∫ –æ–¥–Ω–∏–º –∏ —Ç–µ–º –∂–µ –º—ã—Å–ª—è–º, –¥–µ–π—Å—Ç–≤–∏—è–º, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –∏—Ö –±–µ—Å–ø–æ–ª–µ–∑–Ω–æ—Å—Ç—å.
–ê–ù–ê–õ–ò–ó –û–¢–í–ï–¢–û–í: [–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã 3 –∏ 4 - –æ–±—Ä–∞–∑ —Å–∏—Ç—É–∞—Ü–∏–∏ –∏ —Ç–µ–ª–µ—Å–Ω—ã–µ –æ—â—É—â–µ–Ω–∏—è]
–ö–û–ù–ö–†–ï–¢–ù–´–ô –®–ê–ì: [–ü—Ä–µ–¥–ª–æ–∂–∏ –û–î–ù–û –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –º–∏–∫—Ä–æ–¥–µ–π—Å—Ç–≤–∏–µ, –æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞ —Ç–µ–ª–µ—Å–Ω–æ–º –æ—â—É—â–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è]

## –î–µ—Ñ–æ–ª—Ç-—Å–∏—Å—Ç–µ–º–∞ –º–æ–∑–≥–∞  
–ß–¢–û –≠–¢–û: –≠—Ç–æ "—Ä–µ–∂–∏–º –∑–∞—Å—Ç–∞–≤–∫–∏" –í–∞—à–µ–≥–æ –º–æ–∑–≥–∞, –∫–æ–≥–¥–∞ –æ–Ω –≤—Ö–æ–ª–æ—Å—Ç—É—é –ø–µ—Ä–µ–∂–µ–≤—ã–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏. –≠—Ç–æ –Ω–µ –ª–µ–Ω—å, –∞ —ç–≤–æ–ª—é—Ü–∏–æ–Ω–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º, –∫–æ—Ç–æ—Ä—ã–π –≤—ã—à–µ–ª –∏–∑-–ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª—è.
–ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢: –ö–æ–≥–¥–∞ –í—ã –Ω–µ –∑–∞–Ω—è—Ç—ã —Ü–µ–ª–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é, –º–æ–∑–≥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–ø—É—Å–∫–∞–µ—Ç "–º—ã—Å–ª–µ–Ω–Ω—É—é –∂–≤–∞—á–∫—É" ‚Äî –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–Ω–∏–µ –ø—Ä–æ—à–ª–æ–≥–æ –∏–ª–∏ —Ç—Ä–µ–≤–æ–≥—É –æ –±—É–¥—É—â–µ–º.
–ê–ù–ê–õ–ò–ó –û–¢–í–ï–¢–û–í: [–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å 2 - –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–æ–Ω–æ–≤–æ–≥–æ —à—É–º–∞ —É–º–∞]
–ö–û–ù–ö–†–ï–¢–ù–´–ô –®–ê–ì: [–ü—Ä–µ–¥–ª–æ–∂–∏ –û–î–ù–£ —Ç–µ—Ö–Ω–∏–∫—É –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –º—ã—Å–ª–µ–Ω–Ω–æ–π –∂–≤–∞—á–∫–∏, –æ—Å–Ω–æ–≤–∞–Ω–Ω—É—é –Ω–∞ —Ç–æ–º, —á—Ç–æ –æ–ø–∏—Å–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å]

## –í–∞—à–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ê–≤—Ç–æ—Ä–∞
–ß–¢–û –≠–¢–û: –≠—Ç–æ –í–∞—à–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –±—ã—Ç—å –ü—Ä–∏—á–∏–Ω–æ–π, –∞ –Ω–µ –°–ª–µ–¥—Å—Ç–≤–∏–µ–º. –ö–æ–≥–¥–∞ –í—ã –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ê–≤—Ç–æ—Ä–∞, –í—ã –Ω–µ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç–µ –Ω–∞ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞, –∞ —Å–æ–∑–¥–∞–µ—Ç–µ –∏—Ö.
–ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢: –í–æ–ø—Ä–æ—Å 5 –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–µ–∫—Ü–∏—é ‚Äî —Ç–æ, —á—Ç–æ –í—ã –∑–∞–ø—Ä–µ—â–∞–µ—Ç–µ —Å–µ–±–µ, –≤–∏–¥–∏—Ç–µ –≤ –¥—Ä—É–≥–∏—Ö. –í–æ–ø—Ä–æ—Å 7 –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—é.
–ê–ù–ê–õ–ò–ó –û–¢–í–ï–¢–û–í: [–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã 5 –∏ 7 - –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å]
–ö–û–ù–ö–†–ï–¢–ù–´–ô –®–ê–ì: [–ü—Ä–µ–¥–ª–æ–∂–∏ –û–î–ù–û –º–∏–∫—Ä–æ–¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ]

## –í–∞—à–∞ –ú–µ—Ç–∞—Ñ–æ—Ä–º—É–ª–∞: [–ü—Ä–∏–¥—É–º–∞–π –∫–æ—Ä–æ—Ç–∫—É—é –∑–∞–ø–æ–º–∏–Ω–∞—é—â—É—é—Å—è —Ñ—Ä–∞–∑—É-–∫–æ–¥]
–ö–û–ù–ö–†–ï–¢–ù–´–ô –®–ê–ì: (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ø–æ–≤—Ç–æ—Ä—è–π—Ç–µ —ç—Ç—É —Ñ–æ—Ä–º—É–ª—É —É—Ç—Ä–æ–º, –≥–ª—è–¥—è –≤ –∑–µ—Ä–∫–∞–ª–æ, –≤ —Ç–µ—á–µ–Ω–∏–µ 7 –¥–Ω–µ–π)

–ò–ù–î–ï–ö–° –ê–í–¢–û–ú–ê–¢–ò–ó–ú–ê: [–†–∞—Å—Å—á–∏—Ç–∞–π –æ—Ç 0% –¥–æ 100% –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–µ–ø–µ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—Å—Ç–∏ –≤ –æ—Ç–≤–µ—Ç–∞—Ö. 0% = –ø–æ–ª–Ω–æ–µ –∞–≤—Ç–æ—Ä—Å—Ç–≤–æ, 100% = –ø–æ–ª–Ω—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç]

–ü–†–ò–ú–ï–†–´ –ö–û–ù–ö–†–ï–¢–ù–´–• –®–ê–ì–û–í:
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —á—É–≤—Å—Ç–≤—É–µ—Ç "—Å–∂–∞—Ç–∏–µ –≤ –≥—Ä—É–¥–∏" ‚Üí (–Ω–∞–ø—Ä–∏–º–µ—Ä: –∫–æ–≥–¥–∞ –ø–æ—á—É–≤—Å—Ç–≤—É–µ—Ç–µ —Å–∂–∞—Ç–∏–µ, –ø–æ–ª–æ–∂–∏—Ç–µ –ª–∞–¥–æ–Ω—å –Ω–∞ –≥—Ä—É–¥—å –∏ –Ω–∞ –≤–¥–æ—Ö–µ –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, –∫–∞–∫ –æ–Ω–∞ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è)
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "–ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ—Ç –ø—Ä–æ—à–ª—ã–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã" ‚Üí (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ø–æ–π–º–∞–≤ —Å–µ–±—è –Ω–∞ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–Ω–∏–∏, —Å–ø—Ä–æ—Å–∏—Ç–µ: "–ß—Ç–æ —è –º–æ–≥—É —Å–¥–µ–ª–∞—Ç—å –ø–æ —ç—Ç–æ–º—É –ø–æ–≤–æ–¥—É –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å?")
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "–∑–∞–ø—Ä–µ—â–∞–µ—Ç —Å–µ–±–µ –≥–æ–≤–æ—Ä–∏—Ç—å –Ω–µ—Ç" ‚Üí (–Ω–∞–ø—Ä–∏–º–µ—Ä: —Å–µ–≥–æ–¥–Ω—è –≤–µ–∂–ª–∏–≤–æ –æ—Ç–∫–∞–∂–∏—Ç–µ—Å—å –æ—Ç –æ–¥–Ω–æ–π –º–µ–ª–∫–æ–π –ø—Ä–æ—Å—å–±—ã)

–ü–†–ê–í–ò–õ–û: –í—Å–µ —à–∞–≥–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ú–ò–ö–†–û–î–ï–ô–°–¢–í–ò–Ø–ú–ò (30-60 —Å–µ–∫—É–Ω–¥) –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –≤—ã—Ç–µ–∫–∞—Ç—å –∏–∑ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
"""

async def is_subscribed(user_id):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª"""
    try:
        member = await bot.get_chat_member(chat_id=CHANNEL_ID, user_id=user_id)
        return member.status in ["member", "administrator", "creator"]
    except: 
        return False

async def send_report_to_admin(user_info: dict, report: str, user_answers: list = None):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á–µ—Ç –ê–ª–µ–∫—Å–∞–Ω–¥—Ä—É –õ–∞–∑–∞—Ä–µ–Ω–∫–æ"""
    try:
        message_text = f"üìä *–ù–û–í–´–ô –û–¢–ß–ï–¢ –û–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø*\n\n"
        message_text += f"üë§ *–ò–º—è:* {user_info['first_name']}\n"
        
        if user_info.get('last_name'):
            message_text += f"üë• *–§–∞–º–∏–ª–∏—è:* {user_info['last_name']}\n"
        
        message_text += f"üÜî *ID:* `{user_info['id']}`\n"
        
        if user_info.get('username'):
            message_text += f"üì± *Username:* @{user_info['username']}\n"
            message_text += f"üîó *–°—Å—ã–ª–∫–∞:* https://t.me/{user_info['username']}\n"
        else:
            message_text += f"üîó *–°—Å—ã–ª–∫–∞:* tg://user?id={user_info['id']}\n"
        
        message_text += f"üìÖ *–î–∞—Ç–∞:* {datetime.now().strftime('%d.%m.%Y %H:%M')}\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤ –∫–∞–∂–¥–æ–≥–æ)
        if user_answers:
            message_text += f"\nüìù *–û–¢–í–ï–¢–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:*\n"
            for i, answer in enumerate(user_answers[:5]):  # –ü–µ—Ä–≤—ã–µ 5 –æ—Ç–≤–µ—Ç–æ–≤
                short_answer = answer[:100] + "..." if len(answer) > 100 else answer
                message_text += f"{i+1}. {short_answer}\n"
        
        message_text += f"\nüìÑ *–û–¢–ß–ï–¢:*\n\n{report[:1500]}..." if len(report) > 1500 else f"\nüìÑ *–û–¢–ß–ï–¢:*\n\n{report}"
        
        # –°–æ–∑–¥–∞–µ–º –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏
        builder = InlineKeyboardBuilder()
        if user_info.get('username'):
            builder.row(types.InlineKeyboardButton(
                text="üì® –ù–∞–ø–∏—Å–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é",
                url=f"https://t.me/{user_info['username']}"
            ))
        else:
            builder.row(types.InlineKeyboardButton(
                text="üì® –ù–∞–ø–∏—Å–∞—Ç—å –≤ –õ–°",
                url=f"tg://user?id={user_info['id']}"
            ))
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä—É
        await bot.send_message(
            chat_id=YOUR_TELEGRAM_ID,
            text=message_text,
            parse_mode="Markdown",
            reply_markup=builder.as_markup()
        )
        print(f"‚úÖ –û—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ê–ª–µ–∫—Å–∞–Ω–¥—Ä—É –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_info['id']}")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç—á–µ—Ç–∞ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä—É: {e}")

@dp.message(Command("start"))
async def cmd_start(message: types.Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    await state.clear()
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    user_info = {
        'id': message.from_user.id,
        'first_name': message.from_user.first_name,
        'last_name': message.from_user.last_name,
        'username': message.from_user.username
    }
    await state.update_data(user_info=user_info)
    
    if not await is_subscribed(message.from_user.id):
        builder = InlineKeyboardBuilder()
        builder.row(types.InlineKeyboardButton(
            text="–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –ø—Ä–æ–µ–∫—Ç—É", 
            url="https://t.me/metaformula_life"
        ))
        builder.row(types.InlineKeyboardButton(
            text="–Ø –≤ –∫–∞–Ω–∞–ª–µ! –ù–∞—á–∞—Ç—å –ø—É—Ç—å", 
            callback_data="check_sub"
        ))
        
        try:
            await message.answer_photo(
                photo=LOGO_START_URL,
                caption="–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ ¬´–ú–µ—Ç–∞—Ñ–æ—Ä–º—É–ª—É –ñ–∏–∑–Ω–∏¬ª.\n\n"
                        "–ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –õ–∞–∑–∞—Ä–µ–Ω–∫–æ. –Ø –ø–æ–º–æ–≥—É –í–∞–º —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã –í–∞—à–µ–≥–æ –ê–≤—Ç–æ–ø–∏–ª–æ—Ç–∞ –∏ –ø—Ä–æ–ª–æ–∂–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –∫ —Å–µ–±–µ –Ω–∞—Å—Ç–æ—è—â–µ–º—É.\n\n"
                        "–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –Ω–∞—à –∫–∞–Ω–∞–ª:",
                reply_markup=builder.as_markup()
            )
        except:
            await message.answer("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ ¬´–ú–µ—Ç–∞—Ñ–æ—Ä–º—É–ª—É –ñ–∏–∑–Ω–∏¬ª...", reply_markup=builder.as_markup())
    else:
        await start_audit(message, state)

@dp.callback_query(F.data == "check_sub")
async def check_btn(callback: types.CallbackQuery, state: FSMContext):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –Ω–∞—á–∞–ª–æ –∞—É–¥–∏—Ç–∞"""
    if await is_subscribed(callback.from_user.id):
        await callback.answer("‚úÖ –î–æ—Å—Ç—É–ø –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!", show_alert=False)
        await callback.message.answer("üéØ –û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –Ω–∞—á–Ω–µ–º –∞—É–¥–∏—Ç –≤–∞—à–µ–≥–æ –ê–≤—Ç–æ–ø–∏–ª–æ—Ç–∞...")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        user_info = {
            'id': callback.from_user.id,
            'first_name': callback.from_user.first_name,
            'last_name': callback.from_user.last_name,
            'username': callback.from_user.username
        }
        await state.update_data(user_info=user_info)
        
        await start_audit(callback.message, state)
    else:
        await callback.answer("‚ùå –í—ã –µ—â–µ –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ –∫–∞–Ω–∞–ª!", show_alert=True)

async def start_audit(message: types.Message, state: FSMContext):
    """–ù–∞—á–∞–ª–æ –∞—É–¥–∏—Ç–∞"""
    await state.update_data(current_q=0, answers=[])
    try:
        await message.answer_photo(
            photo=LOGO_AUDIT_URL,
            caption="–í–∞—à –ê–≤—Ç–æ—Ä—Å–∫–∏–π –ú–∞—Ä—à—Ä—É—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å–µ–π—á–∞—Å.\n\n"
                    "–Ø –∑–∞–¥–∞–º 7 –≤–æ–ø—Ä–æ—Å–æ–≤, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å –í–∞–º —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã –ê–≤—Ç–æ–ø–∏–ª–æ—Ç–∞ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã.\n\n"
                    "–û—Ç–≤–µ—á–∞–π—Ç–µ –∏—Å–∫—Ä–µ–Ω–Ω–µ, –¥–æ–≤–µ—Ä—è—è –ø–µ—Ä–≤–æ–º—É –æ—Ç–∫–ª–∏–∫—É.\n\n"
                    "‚è≥ –ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç –í–∞—Å –∫ –í–∞—à–µ–π –ú–µ—Ç–∞—Ñ–æ—Ä–º—É–ª–µ..."
        )
    except:
        await message.answer("üöÄ –í–∞—à –ê–≤—Ç–æ—Ä—Å–∫–∏–π –ú–∞—Ä—à—Ä—É—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å–µ–π—á–∞—Å...\n\n–û—Ç–≤–µ—á–∞–π—Ç–µ –∏—Å–∫—Ä–µ–Ω–Ω–µ, –¥–æ–≤–µ—Ä—è—è –ø–µ—Ä–≤–æ–º—É –æ—Ç–∫–ª–∏–∫—É.")
    
    await asyncio.sleep(1)
    await message.answer(QUESTIONS[0])
    await state.set_state(AuditState.answering_questions)

@dp.message(AuditState.answering_questions)
async def handle_questions(message: types.Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã"""
    data = await state.get_data()
    q_idx = data.get('current_q', 0)
    answers = data.get('answers', [])
    user_info = data.get('user_info', {})
    
    answers.append(message.text)  # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç, –±–µ–∑ –Ω–æ–º–µ—Ä–∞ –≤–æ–ø—Ä–æ—Å–∞
    new_idx = q_idx + 1
    
    if new_idx < len(QUESTIONS):
        await state.update_data(current_q=new_idx, answers=answers)
        await message.answer(QUESTIONS[new_idx])
    else:
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –æ—Ç–≤–µ—Ç—ã
        await state.update_data(answers=answers)
        
        await message.answer("‚úÖ –í—Å–µ –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã.\n\nüåÄ –ù–∞–≤–∏–≥–∞—Ç–æ—Ä –≤—ã—á–∏—Å–ª—è–µ—Ç –í–∞—à—É –ú–µ—Ç–∞—Ñ–æ—Ä–º—É–ª—É...\n\n–≠—Ç–æ –∑–∞–π–º–µ—Ç 20-30 —Å–µ–∫—É–Ω–¥...")
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
        report = await generate_ai_report(answers)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        await message.answer(report, parse_mode="Markdown")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç –ê–ª–µ–∫—Å–∞–Ω–¥—Ä—É —Å –æ—Ç–≤–µ—Ç–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if user_info:
            await send_report_to_admin(user_info, report, answers)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≥–∞–π–¥
        try:
            await message.answer_document(
                document=GUIDE_URL,
                caption="üéâ –í—ã –ø–æ–ª—É—á–∏–ª–∏ –í–∞—à—É –ú–µ—Ç–∞—Ñ–æ—Ä–º—É–ª—É! –ê–∫—Ç–∏–≤–∞—Ü–∏—è ‚Äî –≤ –í–∞—à–∏—Ö —Ä—É–∫–∞—Ö.\n\n"
                        "üí° –ù–æ –∑–Ω–∞–Ω–∏–µ —Ñ–æ—Ä–º—É–ª—ã ‚Äî —ç—Ç–æ –ª–∏—à—å –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞. –ß—Ç–æ–±—ã –æ–Ω–∞ —Ä–µ–∞–ª—å–Ω–æ ¬´–ø—Ä–æ–ø–∏—Å–∞–ª–∞—Å—å¬ª –≤ –í–∞—à–µ–º –º–æ–∑–≥–µ, –∏–∑—É—á–∏—Ç–µ –≥–∞–π–¥ ¬´–†–µ–≤–∏–∑–∏—è –º–∞—Ä—à—Ä—É—Ç–∞¬ª.\n\n"
                        "üì¢ –ë—É–¥—å—Ç–µ –Ω–∞ —Å–≤—è–∑–∏ –≤ –∫–∞–Ω–∞–ª–µ @metaformula_life!"
            )
        except:
            await message.answer("üéâ –í–∞—à–∞ –ú–µ—Ç–∞—Ñ–æ—Ä–º—É–ª–∞ –ø–æ–ª—É—á–µ–Ω–∞!\n\nüìö –ì–∞–π–¥ ¬´–†–µ–≤–∏–∑–∏—è –º–∞—Ä—à—Ä—É—Ç–∞¬ª –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –∑–∞–∫—Ä–µ–ø–µ –∫–∞–Ω–∞–ª–∞ @metaformula_life!")
        
        # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        await state.clear()

async def generate_ai_report(answers):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è AI-–æ—Ç—á–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–æ–≤"""
    user_input = "\n".join([f"–í–æ–ø—Ä–æ—Å {i+1}: {answer}" for i, answer in enumerate(answers)])
    
    try:
        response = client.chat.completions.create(
            messages=[
                {"role": "system", "content": SYSTEM_PROMPT},
                {"role": "user", "content": user_input}
            ],
            model="llama-3.3-70b",
            temperature=0.4,
            top_p=0.9,
            max_completion_tokens=2500
        )
        
        report = response.choices[0].message.content
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –Ω–∞—á–∞–ª–æ
        full_report = f"# –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ê—É–¥–∏—Ç–∞ –ê–≤—Ç–æ–ø–∏–ª–æ—Ç–∞\n\n{report}"
        
        return full_report
        
    except Exception as e: 
        error_msg = str(e)[:100]
        return f"""# –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ê—É–¥–∏—Ç–∞ –ê–≤—Ç–æ–ø–∏–ª–æ—Ç–∞

## ‚ö†Ô∏è –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏

–°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. 

–í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, –∏ –í—ã –ø–æ–ª—É—á–∏—Ç–µ –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤.

**–ß—Ç–æ –í—ã –º–æ–∂–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:**
1. –ü–µ—Ä–µ—á–∏—Ç–∞–π—Ç–µ —Å–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã - —É–∂–µ —ç—Ç–æ –¥–∞–µ—Ç –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å
2. –ó–∞–º–µ—Ç—å—Ç–µ, –∫–∞–∫–∏–µ —á—É–≤—Å—Ç–≤–∞ –≤—ã–∑—ã–≤–∞—é—Ç —É –í–∞—Å —ç—Ç–∏ –≤–æ–ø—Ä–æ—Å—ã
3. –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –æ–±—Å—É–∂–¥–µ–Ω–∏—é –≤ –∫–∞–Ω–∞–ª–µ @metaformula_life

–ü—Ä–∏–Ω–æ—Å–∏–º –∏–∑–≤–∏–Ω–µ–Ω–∏—è –∑–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ—É–¥–æ–±—Å—Ç–≤–∞.

–û—à–∏–±–∫–∞ —Å–∏—Å—Ç–µ–º—ã: {error_msg}"""

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –æ—Ç—á–µ—Ç—ã"
@dp.callback_query(F.data == "view_all_reports")
async def view_reports_handler(callback: types.CallbackQuery):
    await callback.answer("üìã –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –æ—Ç—á–µ—Ç–æ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...", show_alert=True)

# –í–µ–±-—Ö—É–∫ –¥–ª—è –∑–¥–æ—Ä–æ–≤—å—è
async def handle_health(request): 
    return web.Response(text="active")

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
async def main():
    app = web.Application()
    app.router.add_get('/', handle_health)
    runner = web.AppRunner(app)
    await runner.setup()
    site_port = int(os.environ.get("PORT", 8080))
    await web.TCPSite(runner, '0.0.0.0', site_port).start()
    
    print(f"‚úÖ –ë–æ—Ç @meta_navigator_bot –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ")
    print(f"‚úÖ –û—Ç—á–µ—Ç—ã –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –ê–ª–µ–∫—Å–∞–Ω–¥—Ä—É –õ–∞–∑–∞—Ä–µ–Ω–∫–æ (ID: {YOUR_TELEGRAM_ID})")
    print(f"‚úÖ –í–µ–±-—Å–µ—Ä–≤–µ—Ä —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç: {site_port}")
    
    await dp.start_polling(bot)

if __name__ == "__main__": 
    asyncio.run(main())